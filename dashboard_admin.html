<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCAT ¬∑ Panel de Control</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060B18;--bg2:#0C1426;--surface:#0F1D35;--surface2:#162440;
  --border:#1E3050;--border2:#243B5E;
  --accent:#3B82F6;--accent-glow:rgba(59,130,246,0.25);
  --green:#22C55E;--green-dim:rgba(34,197,94,0.12);
  --yellow:#F59E0B;--yellow-dim:rgba(245,158,11,0.12);
  --orange:#F97316;--orange-dim:rgba(249,115,22,0.12);
  --red:#EF4444;--red-dim:rgba(239,68,68,0.12);
  --frozen:#8B5CF6;--frozen-dim:rgba(139,92,246,0.12);
  --text:#F1F5F9;--text-sub:#94A3B8;--text-muted:#4A6080;
  --norte:#60A5FA;--sur:#4ADE80;--suroc:#FCD34D;--co:#C084FC;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;width:100%;}

/* ‚îÄ‚îÄ PIN ‚îÄ‚îÄ */
.pin-screen{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;}
.pin-screen.hidden{display:none;}
.pin-logo{font-size:3rem;margin-bottom:0.5rem;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pin-title{font-size:1.4rem;font-weight:800;text-align:center;margin-bottom:4px;}
.pin-author{font-size:0.72rem;color:var(--accent);font-weight:600;margin-bottom:4px;text-align:center;}
.pin-sub{font-size:0.78rem;color:var(--text-sub);text-align:center;margin-bottom:1.5rem;line-height:1.5;}
.pin-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:1.8rem;width:100%;max-width:360px;box-shadow:0 24px 80px rgba(0,0,0,0.5);}
.pin-label{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-sub);margin-bottom:10px;text-align:center;}
.pin-input-wrap{display:flex;gap:10px;justify-content:center;margin-bottom:1.2rem;}
.pin-digit{width:52px;height:60px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--text);transition:all 0.2s;caret-color:var(--accent);}
.pin-digit:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow);background:var(--surface);}
.btn-pin{width:100%;padding:14px;background:var(--accent);border:none;border-radius:12px;color:#fff;font-family:'Outfit',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;}
.pin-error{text-align:center;margin-top:10px;font-size:0.8rem;color:var(--red);font-weight:600;display:none;}
.pin-hint{text-align:center;margin-top:12px;font-size:0.7rem;color:var(--text-muted);}
.pin-hint strong{color:var(--text-sub);}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
.app{display:none;width:100%;}
.app.visible{display:block;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{position:sticky;top:0;z-index:100;background:rgba(6,11,24,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center;padding:0 1.5rem;gap:1rem;}
.topbar-logo{font-size:0.92rem;font-weight:800;display:flex;align-items:center;gap:8px;white-space:nowrap;}
.logo-badge{background:var(--accent);color:#fff;font-size:0.58rem;font-weight:700;padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:0.06em;}
.topbar-tabs{display:flex;gap:4px;margin-left:0.5rem;}
.tab-btn{padding:5px 12px;border-radius:8px;border:none;background:none;color:var(--text-sub);font-family:'Outfit',sans-serif;font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.tab-btn:hover{background:var(--surface2);color:var(--text);}
.tab-btn.active{background:var(--surface2);color:var(--accent);border:1px solid var(--border2);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.clock-display{font-family:'JetBrains Mono',monospace;font-size:0.78rem;color:var(--text-sub);background:var(--surface);border:1px solid var(--border);padding:3px 9px;border-radius:6px;}
.sync-tag{font-size:0.65rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace;}
.btn-top{padding:4px 10px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--text-muted);font-size:0.72rem;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;}
.btn-top:hover{border-color:var(--accent);color:var(--accent);}
.btn-logout:hover{border-color:var(--red);color:var(--red);}

/* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
.view{display:none;padding:1.5rem;max-width:100%;min-height:calc(100vh - 56px);}
.view.active{display:block;}

/* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
.alert-banner{display:none;border-radius:12px;padding:12px 16px;margin-bottom:1rem;}
.alert-banner.show{display:flex;align-items:center;gap:12px;}
.alert-banner.crit{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.4);}
.alert-banner.doblado{background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.4);}
.alert-banner.frozen-alert{background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.4);}
.alert-banner-text{flex:1;font-size:0.8rem;line-height:1.5;}
.alert-banner-text strong{display:block;font-size:0.88rem;margin-bottom:2px;}
.alert-banner.crit .alert-banner-text strong{color:var(--red);}
.alert-banner.doblado .alert-banner-text strong{color:var(--orange);}
.alert-banner.frozen-alert .alert-banner-text strong{color:var(--frozen);}
.btn-notify{padding:6px 12px;background:var(--red);border:none;border-radius:8px;color:#fff;font-size:0.72rem;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap;}

/* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:1rem;margin-bottom:1.5rem;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1rem 1.1rem;position:relative;overflow:hidden;}
.kpi-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;}
.kpi-card.k-total::after{background:var(--accent);}
.kpi-card.k-ok::after{background:var(--green);}
.kpi-card.k-warn::after{background:var(--yellow);}
.kpi-card.k-frozen::after{background:var(--frozen);}
.kpi-card.k-dob::after{background:var(--orange);animation:pulse-bar 2s infinite;}
.kpi-card.k-crit::after{background:var(--red);animation:pulse-bar 2s infinite;}
@keyframes pulse-bar{0%,100%{opacity:1}50%{opacity:0.4}}
.kpi-num{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:600;line-height:1;}
.kpi-card.k-total .kpi-num{color:var(--accent);}
.kpi-card.k-ok .kpi-num{color:var(--green);}
.kpi-card.k-warn .kpi-num{color:var(--yellow);}
.kpi-card.k-frozen .kpi-num{color:var(--frozen);}
.kpi-card.k-dob .kpi-num{color:var(--orange);}
.kpi-card.k-crit .kpi-num{color:var(--red);}
.kpi-label{font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-top:5px;}
.kpi-sub{font-size:0.6rem;color:var(--text-muted);margin-top:2px;}

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:1rem;flex-wrap:wrap;}
.filter-chip{padding:4px 12px;border-radius:20px;border:1px solid var(--border);background:none;color:var(--text-muted);font-size:0.72rem;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:'Outfit',sans-serif;}
.filter-chip:hover{border-color:var(--accent);color:var(--accent);}
.filter-chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.filter-chip.norte.active{background:var(--norte);border-color:var(--norte);color:#000;}
.filter-chip.sur.active{background:var(--sur);border-color:var(--sur);color:#000;}
.filter-chip.suroc.active{background:var(--suroc);border-color:var(--suroc);color:#000;}
.filter-chip.co.active{background:var(--co);border-color:var(--co);color:#000;}
.filter-chip.warn-f.active{background:var(--yellow);border-color:var(--yellow);color:#000;}
.filter-chip.dob-f.active{background:var(--orange);border-color:var(--orange);color:#000;}
.filter-chip.crit-f.active{background:var(--red);border-color:var(--red);color:#fff;}
.filter-chip.frozen-f.active{background:var(--frozen);border-color:var(--frozen);color:#fff;}
.search-box{padding:5px 11px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Outfit',sans-serif;font-size:0.78rem;width:140px;}
.search-box:focus{outline:none;border-color:var(--accent);}
.spacer{flex:1;}
.btn-export{display:flex;align-items:center;gap:5px;padding:5px 11px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text-sub);font-size:0.72rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;}
.btn-export:hover{border-color:var(--accent);color:var(--accent);}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap{overflow-x:auto;border-radius:14px;border:1px solid var(--border);width:100%;}
table{width:100%;border-collapse:collapse;font-size:0.78rem;min-width:960px;}
thead th{background:var(--surface2);padding:9px 11px;text-align:left;font-size:0.6rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);white-space:nowrap;border-bottom:1px solid var(--border);}
tbody tr{border-bottom:1px solid rgba(30,48,80,0.5);transition:background 0.15s;}
tbody tr:hover{background:rgba(255,255,255,0.02);}
tbody tr.r-crit{background:rgba(239,68,68,0.05);}
tbody tr.r-crit td:first-child{border-left:3px solid var(--red);}
tbody tr.r-dob{background:rgba(249,115,22,0.05);}
tbody tr.r-dob td:first-child{border-left:3px solid var(--orange);}
tbody tr.r-warn{background:rgba(245,158,11,0.05);}
tbody tr.r-warn td:first-child{border-left:3px solid var(--yellow);}
tbody tr.r-frozen{background:rgba(139,92,246,0.05);}
tbody tr.r-frozen td:first-child{border-left:3px solid var(--frozen);}
td{padding:9px 11px;vertical-align:middle;}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.b-subred{padding:3px 9px;border-radius:20px;font-size:0.64rem;font-weight:700;display:inline-block;white-space:nowrap;}
.b-subred.norte{background:rgba(96,165,250,0.12);color:var(--norte);border:1px solid rgba(96,165,250,0.25);}
.b-subred.sur{background:rgba(74,222,128,0.12);color:var(--sur);border:1px solid rgba(74,222,128,0.25);}
.b-subred.suroc{background:rgba(252,211,77,0.12);color:var(--suroc);border:1px solid rgba(252,211,77,0.25);}
.b-subred.co{background:rgba(192,132,252,0.12);color:var(--co);border:1px solid rgba(192,132,252,0.25);}
.b-tipo{padding:2px 7px;border-radius:4px;font-size:0.6rem;font-weight:700;background:var(--surface2);color:var(--text-muted);border:1px solid var(--border);}
.hours-tag{font-family:'JetBrains Mono',monospace;font-size:0.76rem;font-weight:600;padding:3px 9px;border-radius:6px;display:inline-block;white-space:nowrap;}
.hours-tag.ok{background:var(--green-dim);color:var(--green);}
.hours-tag.warn{background:var(--yellow-dim);color:var(--yellow);}
.hours-tag.dob{background:var(--orange-dim);color:var(--orange);}
.hours-tag.crit{background:var(--red-dim);color:var(--red);animation:glow-red 2s infinite;}
.hours-tag.frozen{background:var(--frozen-dim);color:var(--frozen);animation:glow-frozen 2s infinite;}
@keyframes glow-red{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(239,68,68,0.4)}}
@keyframes glow-frozen{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(139,92,246,0.5)}}
.status-chip{font-size:0.65rem;font-weight:700;padding:3px 9px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;white-space:nowrap;}
.status-chip.ok{background:var(--green-dim);color:var(--green);}
.status-chip.warn{background:var(--yellow-dim);color:var(--yellow);}
.status-chip.dob{background:var(--orange-dim);color:var(--orange);}
.status-chip.crit{background:var(--red-dim);color:var(--red);}
.status-chip.frozen{background:var(--frozen-dim);color:var(--frozen);}
.b-doblado{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:0.58rem;font-weight:800;text-transform:uppercase;letter-spacing:0.05em;white-space:nowrap;}
.b-doblado.d1{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(249,115,22,0.3);}
.b-doblado.d2{background:var(--red-dim);color:var(--red);border:1px solid rgba(239,68,68,0.3);}
.person-block{display:flex;flex-direction:column;gap:1px;}
.person-name{font-weight:500;font-size:0.78rem;color:var(--text);white-space:nowrap;}
.person-doc{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text-muted);}
.na-tag{color:var(--text-muted);font-size:0.7rem;}
.photo-link{font-size:0.6rem;color:var(--accent);text-decoration:none;display:block;margin-top:2px;}
.photo-link:hover{text-decoration:underline;}
.btn-action{padding:4px 9px;border-radius:6px;border:none;font-size:0.68rem;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;white-space:nowrap;}
.btn-cerrar{background:var(--surface2);color:var(--text-sub);border:1px solid var(--border);}
.btn-cerrar:hover{border-color:var(--green);color:var(--green);}
.btn-detener{background:var(--red-dim);color:var(--red);border:1px solid rgba(239,68,68,0.3);}
.btn-detener:hover{background:rgba(239,68,68,0.2);}
.btn-relay{background:var(--frozen-dim);color:var(--frozen);border:1px solid rgba(139,92,246,0.3);}
.btn-relay:hover{background:rgba(139,92,246,0.2);}

/* ‚îÄ‚îÄ HISTORIAL ‚îÄ‚îÄ */
.date-filter-bar{display:flex;align-items:center;gap:10px;margin-bottom:1rem;flex-wrap:wrap;}
.date-input{padding:5px 11px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Outfit',sans-serif;font-size:0.78rem;}
.date-input:focus{outline:none;border-color:var(--accent);}
.day-chip{padding:4px 12px;border-radius:20px;border:1px solid var(--border);background:none;color:var(--text-muted);font-size:0.72rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;}
.day-chip:hover{border-color:var(--accent);color:var(--accent);}
.day-chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}

/* ‚îÄ‚îÄ SUBRED GRID ‚îÄ‚îÄ */
.subred-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;}
.subred-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
.subred-panel-head{padding:13px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.subred-panel-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.subred-panel-name{font-size:0.88rem;font-weight:700;}
.subred-panel-count{margin-left:auto;display:flex;gap:5px;}
.mini-count{font-size:0.6rem;font-weight:700;padding:2px 7px;border-radius:4px;font-family:'JetBrains Mono',monospace;}
.mini-count.ok{background:var(--green-dim);color:var(--green);}
.mini-count.warn{background:var(--yellow-dim);color:var(--yellow);}
.mini-count.dob{background:var(--orange-dim);color:var(--orange);}
.mini-count.crit{background:var(--red-dim);color:var(--red);}
.mini-count.frozen{background:var(--frozen-dim);color:var(--frozen);}
.subred-panel-body{padding:10px;}
.subred-row{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:9px 11px;margin-bottom:7px;}
.subred-row:last-child{margin-bottom:0;}
.subred-row.r-crit{border-color:rgba(239,68,68,0.35);background:rgba(239,68,68,0.04);}
.subred-row.r-dob{border-color:rgba(249,115,22,0.35);background:rgba(249,115,22,0.04);}
.subred-row.r-warn{border-color:rgba(245,158,11,0.35);background:rgba(245,158,11,0.04);}
.subred-row.r-frozen{border-color:rgba(139,92,246,0.35);background:rgba(139,92,246,0.04);}
.subred-row-top{display:flex;align-items:center;gap:7px;margin-bottom:5px;flex-wrap:wrap;}
.subred-row-placa{font-family:'JetBrains Mono',monospace;font-size:0.82rem;font-weight:600;}
.subred-row-people{display:flex;flex-direction:column;gap:3px;font-size:0.72rem;}
.subred-row-person{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
.srp-role{font-weight:700;min-width:56px;}
.srp-role.med{color:var(--norte);}
.srp-role.con{color:var(--sur);}
.srp-role.aux{color:var(--co);}
.srp-name{color:var(--text-sub);}
.srp-doc{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text-muted);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:1.8rem;width:100%;max-width:420px;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:slideUp 0.3s ease;}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-size:1.05rem;font-weight:800;margin-bottom:6px;}
.modal-detail{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:11px 13px;margin:1rem 0;font-size:0.8rem;color:var(--text-sub);line-height:1.7;}
.modal-detail strong{color:var(--text);display:block;margin-bottom:3px;}
.modal-warn{border-radius:8px;padding:9px 11px;margin-bottom:10px;font-size:0.76rem;line-height:1.5;}
.modal-warn.orange{background:var(--orange-dim);border:1px solid rgba(249,115,22,0.3);color:var(--orange);}
.modal-warn.purple{background:var(--frozen-dim);border:1px solid rgba(139,92,246,0.3);color:var(--frozen);}
.modal-buttons{display:flex;gap:10px;margin-top:1.2rem;}
.btn-modal-cancel{flex:1;padding:11px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--text-sub);cursor:pointer;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.83rem;}
.btn-modal-confirm{flex:2;padding:11px;background:var(--green);border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;font-size:0.83rem;}
.btn-modal-detener{flex:2;padding:11px;background:var(--red);border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;font-size:0.83rem;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(6,11,24,0.7);backdrop-filter:blur(4px);align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.loading-overlay.show{display:flex;}
.loading-ring{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:0.82rem;color:var(--text-sub);}
.spinner{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;margin-right:5px;}

.empty{text-align:center;padding:3rem;color:var(--text-muted);font-size:0.83rem;}
.closed-row{opacity:0.65;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
.footer-credit{text-align:center;padding:16px;font-size:0.62rem;color:var(--text-muted);border-top:1px solid var(--border);}
.footer-credit strong{color:var(--accent);}

/* ‚îÄ‚îÄ SPLASH CREDIT ‚îÄ‚îÄ */
.splash-credit{font-size:0.68rem;color:var(--text-muted);text-align:center;margin-top:1rem;line-height:1.5;}
.splash-credit strong{color:var(--accent);}

@media(max-width:900px){.kpi-row{grid-template-columns:repeat(3,1fr);}.subred-grid{grid-template-columns:1fr;}}
@media(max-width:600px){.kpi-row{grid-template-columns:repeat(2,1fr);}.view{padding:1rem;}.topbar{padding:0 1rem;gap:5px;}.topbar-tabs{gap:2px;}.tab-btn{font-size:0.7rem;padding:4px 8px;}}
</style>
</head>
<body>

<!-- PIN -->
<div class="pin-screen" id="pin-screen">
  <div class="pin-logo">üöë</div>
  <div class="pin-title">SCAT ¬∑ Panel de Control</div>
  <div class="pin-author">Desarrollado por Ing. Edisson Mac√≠as</div>
  <div class="pin-sub">Secretar√≠a de Salud ¬∑ Bogot√° D.C.<br>Sistema de Control de Ambulancias y Turnos</div>
  <div class="pin-box">
    <div class="pin-label">Ingrese su clave de acceso</div>
    <div class="pin-input-wrap">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p1">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p2">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p3">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p4">
    </div>
    <button class="btn-pin" onclick="checkPin()">INGRESAR ‚Üí</button>
    <div class="pin-error" id="pin-error">Clave incorrecta. Intente de nuevo.</div>
    <div class="pin-hint">Clave: <strong>1234</strong></div>
  </div>
  <div class="splash-credit">Sistema SCAT v2.0 ¬∑ <strong>Ing. Edisson Mac√≠as</strong><br>Secretar√≠a de Salud Bogot√° ¬∑ 2026</div>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-ring"></div>
  <div class="loading-text" id="loading-text">Cargando...</div>
</div>

<!-- APP -->
<div class="app" id="app">
  <header class="topbar">
    <div class="topbar-logo">üöë SCAT <span class="logo-badge">Admin</span></div>
    <nav class="topbar-tabs">
      <button class="tab-btn active" onclick="showTab('dashboard',this)">üìä Dashboard</button>
      <button class="tab-btn" onclick="showTab('subredes',this)">üìç Subredes</button>
      <button class="tab-btn" onclick="showTab('historial',this)">üìã Historial</button>
    </nav>
    <div class="topbar-right">
      <div class="live-dot"></div>
      <span class="sync-tag" id="sync-tag">--</span>
      <div class="clock-display" id="clock">--:--:--</div>
      <button class="btn-top" onclick="forceRefresh()">‚ü≥ Sync</button>
      <button class="btn-top btn-logout" onclick="logout()">Salir</button>
    </div>
  </header>

  <!-- DASHBOARD -->
  <div class="view active" id="tab-dashboard">
    <div class="alert-banner crit" id="alert-crit">
      <div>‚õî</div>
      <div class="alert-banner-text"><strong id="alert-crit-title"></strong><span id="alert-crit-msg"></span></div>
      <button class="btn-notify" onclick="sendNotification('crit')">üîî Notificar</button>
    </div>
    <div class="alert-banner doblado" id="alert-dob">
      <div>‚ö†Ô∏è</div>
      <div class="alert-banner-text"><strong id="alert-dob-title"></strong><span id="alert-dob-msg"></span></div>
      <button class="btn-notify" style="background:var(--orange)" onclick="sendNotification('dob')">üîî Notificar</button>
    </div>
    <div class="alert-banner frozen-alert" id="alert-frozen">
      <div>üü£</div>
      <div class="alert-banner-text"><strong id="alert-frozen-title"></strong><span id="alert-frozen-msg"></span></div>
    </div>
    <div class="kpi-row" id="kpi-row"></div>
    <div class="toolbar" id="toolbar">
      <button class="filter-chip active" onclick="setFilter('all',this)">Todas</button>
      <button class="filter-chip norte" onclick="setFilter('Norte',this)">Norte</button>
      <button class="filter-chip sur" onclick="setFilter('Sur',this)">Sur</button>
      <button class="filter-chip suroc" onclick="setFilter('Sur Occidente',this)">Sur Occidente</button>
      <button class="filter-chip co" onclick="setFilter('Centro Oriente',this)">Centro Oriente</button>
      <button class="filter-chip warn-f" onclick="setStatusFilter('warn',this)">üü° Por vencer</button>
      <button class="filter-chip frozen-f" onclick="setStatusFilter('frozen',this)">üü£ Congeladas</button>
      <button class="filter-chip dob-f" onclick="setStatusFilter('dob',this)">üü† Doblados</button>
      <button class="filter-chip crit-f" onclick="setStatusFilter('crit',this)">üî¥ Cr√≠ticos</button>
      <input class="search-box" type="text" placeholder="üîç Buscar placa..." oninput="searchFilter(this.value)" id="search-box">
      <div class="spacer"></div>
      <button class="btn-export" onclick="exportExcel()">üìä Excel</button>
      <button class="btn-export" onclick="exportTxt()">‚¨á Texto</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Subred</th><th>M√≥vil</th><th>Tipo</th>
            <th>M√©dico</th><th>Conductor</th><th>Auxiliar</th>
            <th>Turno</th><th>Inicio</th><th>Tiempo</th>
            <th>Estado</th><th>Personal</th><th>Referente</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="main-tbody"></tbody>
      </table>
      <div class="empty" id="main-empty" style="display:none">
        <div style="font-size:2.5rem;margin-bottom:8px">üöë</div>
        No hay m√≥viles activas con los filtros actuales
      </div>
    </div>
  </div>

  <!-- SUBREDES -->
  <div class="view" id="tab-subredes">
    <div class="subred-grid" id="subred-grid"></div>
  </div>

  <!-- HISTORIAL -->
  <div class="view" id="tab-historial">
    <div class="date-filter-bar">
      <div style="font-size:1rem;font-weight:700;margin-right:4px">Historial de Turnos</div>
      <button class="day-chip active" onclick="setDayFilter('today',this)">Hoy</button>
      <button class="day-chip" onclick="setDayFilter('yesterday',this)">Ayer</button>
      <button class="day-chip" onclick="setDayFilter('week',this)">Esta semana</button>
      <button class="day-chip" onclick="setDayFilter('all',this)">Todo</button>
      <input class="date-input" type="date" id="date-from" onchange="setDayFilter('custom',null)">
      <input class="date-input" type="date" id="date-to" onchange="setDayFilter('custom',null)">
      <div class="spacer"></div>
      <button class="btn-export" onclick="exportHistorialExcel()">üìä Excel</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Fecha</th><th>Subred</th><th>M√≥vil</th><th>Tipo</th><th>Conductor</th><th>Auxiliar</th><th>M√©dico</th><th>Inicio</th><th>Cierre</th><th>Total horas</th><th>Resultado</th></tr>
        </thead>
        <tbody id="hist-tbody"></tbody>
      </table>
      <div class="empty" id="hist-empty">No hay turnos cerrados en el per√≠odo seleccionado</div>
    </div>
  </div>

  <div class="footer-credit">Sistema SCAT v2.0 ¬∑ Desarrollado por <strong>Ing. Edisson Mac√≠as</strong> ¬∑ Secretar√≠a de Salud Bogot√° ¬∑ 2026</div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modal-title"></div>
    <div style="font-size:0.8rem;color:var(--text-sub)" id="modal-sub"></div>
    <div class="modal-warn orange" id="modal-dob-warn" style="display:none"></div>
    <div class="modal-warn purple" id="modal-frozen-warn" style="display:none"></div>
    <div class="modal-detail" id="modal-detail"></div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal()">Cancelar</button>
      <button id="modal-confirm-btn"></button>
    </div>
  </div>
</div>

<script>
const PIN         = '1234';
const LOCAL_KEY   = 'scat_registros_v3';
const CLOSED_KEY  = 'scat_cerrados_v3';
const SHEET_URL   = 'https://script.google.com/macros/s/AKfycbwvimLL3DM70rOD1_WvFwgBLeWiPKqaftODpR3U9XAU2aeY45uALX8QOpuTuMkF8QaB/exec';
const SHIFT_HOURS = 12;

let activeFilter  = 'all';
let statusFilter  = null;
let searchQuery   = '';
let dayFilter     = 'today';
let pendingAction = null;
let activeData    = [];
let closedData    = [];
let autoRefreshTimer = null;

// ‚îÄ‚îÄ PIN ‚îÄ‚îÄ
function checkPin() {
  const code = ['p1','p2','p3','p4'].map(id=>document.getElementById(id).value).join('');
  if (code === PIN) {
    document.getElementById('pin-screen').classList.add('hidden');
    document.getElementById('app').classList.add('visible');
    loadData(); startAutoRefresh();
    requestNotificationPermission();
  } else {
    document.getElementById('pin-error').style.display='block';
    ['p1','p2','p3','p4'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('p1').focus();
    setTimeout(()=>document.getElementById('pin-error').style.display='none',3000);
  }
}
['p1','p2','p3','p4'].forEach((id,i)=>{
  const ids=['p1','p2','p3','p4'];
  const el=document.getElementById(id);
  el.addEventListener('input',()=>{ if(el.value.length===1&&i<3) document.getElementById(ids[i+1]).focus(); if(i===3&&el.value.length===1) checkPin(); });
  el.addEventListener('keydown',e=>{ if(e.key==='Backspace'&&!el.value&&i>0) document.getElementById(ids[i-1]).focus(); if(e.key==='Enter') checkPin(); });
});
document.getElementById('p1').focus();

function logout() {
  clearInterval(autoRefreshTimer);
  document.getElementById('app').classList.remove('visible');
  document.getElementById('pin-screen').classList.remove('hidden');
  ['p1','p2','p3','p4'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('p1').focus();
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
setInterval(()=>{ document.getElementById('clock').textContent=new Date().toLocaleTimeString('es-CO',{hour12:false}); },1000);

// ‚îÄ‚îÄ DATA LOAD ‚îÄ‚îÄ
async function loadData(silent=false) {
  if (!silent) showLoading('Sincronizando con Google Sheets...');
  try {
    const json = await new Promise((resolve, reject) => {
      const script  = document.createElement('script');
      const cbName  = '_scatCb_'+Date.now();
      window[cbName]= (data)=>{ delete window[cbName]; script.remove(); resolve(data); };
      script.onerror= ()=>reject(new Error('Script error'));
      script.src    = SHEET_URL+'?action=getAll&callback='+cbName;
      setTimeout(()=>reject(new Error('Timeout')), 8000);
      document.head.appendChild(script);
    });
    if (json.status==='ok') {
      // Respect locally closed records - never let server revive them
      const localClosed    = JSON.parse(localStorage.getItem(CLOSED_KEY)||'[]');
      const closedIds      = new Set(localClosed.map(r=>String(r.id)));
      activeData           = (json.active||[]).filter(r=>!closedIds.has(String(r.id)));
      const serverClosed   = json.closed||[];
      const serverClosedIds= new Set(serverClosed.map(r=>String(r.id)));
      const localOnly      = localClosed.filter(r=>!serverClosedIds.has(String(r.id)));
      closedData           = [...serverClosed,...localOnly];
      localStorage.setItem(LOCAL_KEY,  JSON.stringify(activeData));
      localStorage.setItem(CLOSED_KEY, JSON.stringify(closedData));
      document.getElementById('sync-tag').textContent='sync '+new Date().toLocaleTimeString('es-CO',{hour12:false,hour:'2-digit',minute:'2-digit'});
    } else throw new Error();
  } catch {
    activeData = JSON.parse(localStorage.getItem(LOCAL_KEY)||'[]').filter(r=>r.estado!=='cerrado');
    closedData = JSON.parse(localStorage.getItem(CLOSED_KEY)||'[]');
    document.getElementById('sync-tag').textContent='‚ö† sin sync';
  }

  // Auto-remove frozen records with no relay after 12h
  autoRemoveFrozen();

  hideLoading();
  renderAll();
  checkAlerts();
}

// ‚îÄ‚îÄ AUTO-REMOVE FROZEN WITHOUT RELAY ‚îÄ‚îÄ
function autoRemoveFrozen() {
  const toRemove = [];
  activeData.forEach(r => {
    const h = getHoursRaw(r.inicio);
    if (h >= SHIFT_HOURS) {
      // Check if a relay registered (same placa, newer registro)
      const hasRelay = activeData.some(r2 =>
        r2.placa === r.placa &&
        String(r2.id) !== String(r.id) &&
        new Date(r2.inicio) > new Date(r.inicio)
      );
      if (!hasRelay) {
        // Mark frozen - don't remove yet, admin closes manually
        // But after 13h with no relay, flag as pending removal
      }
    }
  });
}

// ‚îÄ‚îÄ CLOSE RECORD ‚îÄ‚îÄ
async function closeRecord(id, action, record) {
  const entry = { ...record, cierre: new Date().toISOString(), accion: action, cerrado_por: 'Admin Dashboard', estado: 'cerrado' };

  // Remove locally and permanently
  activeData = activeData.filter(r => String(r.id) !== String(id));
  closedData.push(entry);
  localStorage.setItem(LOCAL_KEY,  JSON.stringify(activeData));
  localStorage.setItem(CLOSED_KEY, JSON.stringify(closedData));
  renderAll();

  // Send to server via JSONP
  try {
    await new Promise((resolve) => {
      const cbName = '_scatClose_'+Date.now();
      const script = document.createElement('script');
      window[cbName]= ()=>{ delete window[cbName]; script.remove(); resolve(); };
      script.onerror= ()=>{ script.remove(); resolve(); };
      const params  = new URLSearchParams({ action:'close', id:String(id), entry:JSON.stringify(entry), callback:cbName });
      script.src    = SHEET_URL+'?'+params.toString();
      setTimeout(()=>resolve(), 8000);
      document.head.appendChild(script);
    });
  } catch {}
}

function startAutoRefresh() {
  clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(()=>loadData(true), 60000);
}
function forceRefresh() { loadData(false); }

// ‚îÄ‚îÄ TIME LOGIC ‚îÄ‚îÄ
function getHoursRaw(iso) { return (Date.now() - new Date(iso)) / 3600000; }

// Frozen: show max 12:00 if >= 12h
function getDisplayHours(iso) {
  const h = getHoursRaw(iso);
  return h >= SHIFT_HOURS ? SHIFT_HOURS : h;
}

function fmtHours(h) {
  const capped = Math.min(h, SHIFT_HOURS);
  if (h >= SHIFT_HOURS) return `‚ùÑ 12:00`;
  return `${Math.floor(capped)}h ${Math.round((capped%1)*60)}m`;
}

function fmtDate(iso)      { if(!iso) return '‚Äî'; return new Date(iso).toLocaleString('es-CO',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); }
function fmtDateShort(iso) { if(!iso) return '‚Äî'; return new Date(iso).toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function subClass(s)       { return s==='Norte'?'norte':s==='Sur'?'sur':s==='Sur Occidente'?'suroc':s==='Centro Oriente'?'co':''; }
function todayStr()        { return new Date().toISOString().slice(0,10); }

// Status: frozen = exactly at 12h, waiting for relay
function getShiftStatus(iso) {
  const h = getHoursRaw(iso);
  if (h > 24)        return 'crit';
  if (h >= SHIFT_HOURS) return 'frozen'; // congelado esperando relevo
  if (h >= 11)       return 'warn';
  return 'ok';
}

// Check if relay came in (same placa, newer record today)
function hasRelay(record) {
  return activeData.some(r2 =>
    r2.placa === record.placa &&
    String(r2.id) !== String(record.id) &&
    new Date(r2.inicio) > new Date(record.inicio)
  );
}

// Doblado detection
function countConsecutiveTurnos(cedula) {
  if (!cedula) return 0;
  const cutoff = Date.now() - 48*3600000;
  return closedData.filter(r => {
    const t = new Date(r.cierre||r.inicio).getTime();
    return t>=cutoff && (r.con_cedula===cedula||r.aux_cedula===cedula||r.med_cedula===cedula);
  }).length;
}

function getDobladoInfo(record) {
  const cedulas = [
    {cedula:record.con_cedula,nombre:record.con_nombre,rol:'Conductor'},
    {cedula:record.aux_cedula,nombre:record.aux_nombre,rol:'Auxiliar'},
    {cedula:record.med_cedula,nombre:record.med_nombre,rol:'M√©dico'},
  ].filter(p=>p.cedula);
  let maxTurnos=0, doblados=[];
  cedulas.forEach(p=>{ const n=countConsecutiveTurnos(p.cedula); if(n>0){doblados.push({...p,turnos:n+1}); if(n+1>maxTurnos) maxTurnos=n+1;}});
  return {maxTurnos,doblados};
}

// ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission==='default') Notification.requestPermission();
}

function checkAlerts() {
  const crits   = activeData.filter(r=>getShiftStatus(r.inicio)==='crit');
  const dobs    = activeData.filter(r=>{ const st=getShiftStatus(r.inicio); return st==='dob'||getDobladoInfo(r).maxTurnos>=2; });
  const frozens = activeData.filter(r=>getShiftStatus(r.inicio)==='frozen');

  const critBanner=document.getElementById('alert-crit');
  if(crits.length){ critBanner.classList.add('show'); document.getElementById('alert-crit-title').textContent=`‚õî ${crits.length} m√≥vil(es) superando 24 horas`; document.getElementById('alert-crit-msg').textContent=crits.map(r=>`${r.placa} (${r.subred})`).join(' ¬∑ '); } else critBanner.classList.remove('show');

  const dobBanner=document.getElementById('alert-dob');
  if(dobs.length){ dobBanner.classList.add('show'); document.getElementById('alert-dob-title').textContent=`‚ö†Ô∏è ${dobs.length} m√≥vil(es) con personal doblando turno`; document.getElementById('alert-dob-msg').textContent=dobs.map(r=>`${r.placa}`).join(' ¬∑ '); } else dobBanner.classList.remove('show');

  const frozenBanner=document.getElementById('alert-frozen');
  if(frozens.length){ frozenBanner.classList.add('show'); document.getElementById('alert-frozen-title').textContent=`üü£ ${frozens.length} m√≥vil(es) esperando relevo ‚Äî tiempo congelado en 12:00`; document.getElementById('alert-frozen-msg').textContent=frozens.map(r=>`${r.placa} (${r.subred})`).join(' ¬∑ '); } else frozenBanner.classList.remove('show');
}

function sendNotification(type) {
  if (!('Notification' in window)||Notification.permission!=='granted') return;
  if(type==='crit'){ const c=activeData.filter(r=>getShiftStatus(r.inicio)==='crit'); new Notification('üöë SCAT ‚Äî M√≥viles Cr√≠ticas',{body:c.map(r=>`${r.placa} ¬∑ ${r.subred}`).join('\n'),tag:'scat-crit',requireInteraction:true}); }
  else { const d=activeData.filter(r=>getShiftStatus(r.inicio)==='dob'); new Notification('‚ö†Ô∏è SCAT ‚Äî Personal Doblado',{body:d.map(r=>`${r.placa} ¬∑ ${r.subred}`).join('\n'),tag:'scat-dob'}); }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderAll() { renderKPI(); renderTable(); renderSubredes(); renderHistorial(); }

function renderKPI() {
  const crit  = activeData.filter(r=>getShiftStatus(r.inicio)==='crit').length;
  const frozen= activeData.filter(r=>getShiftStatus(r.inicio)==='frozen').length;
  const warn  = activeData.filter(r=>getShiftStatus(r.inicio)==='warn').length;
  const ok    = activeData.filter(r=>getShiftStatus(r.inicio)==='ok').length;
  document.getElementById('kpi-row').innerHTML=`
    <div class="kpi-card k-total"><div class="kpi-num">${activeData.length}</div><div class="kpi-label">M√≥viles Activas</div><div class="kpi-sub">En este momento</div></div>
    <div class="kpi-card k-ok"><div class="kpi-num">${ok}</div><div class="kpi-label">Normal</div><div class="kpi-sub">Menos de 11h</div></div>
    <div class="kpi-card k-warn"><div class="kpi-num">${warn}</div><div class="kpi-label">Por Vencer</div><div class="kpi-sub">Entre 11h y 12h</div></div>
    <div class="kpi-card k-frozen"><div class="kpi-num">${frozen}</div><div class="kpi-label">Esperando Relevo</div><div class="kpi-sub">‚ùÑ Tiempo congelado</div></div>
    <div class="kpi-card k-dob"><div class="kpi-num">${activeData.filter(r=>getDobladoInfo(r).maxTurnos>=2).length}</div><div class="kpi-label">Doblando</div><div class="kpi-sub">Personal 2¬∞ turno</div></div>
    <div class="kpi-card k-crit"><div class="kpi-num">${crit}</div><div class="kpi-label">Cr√≠tico</div><div class="kpi-sub">M√°s de 24h ‚ö†Ô∏è</div></div>`;
}

function renderTable() {
  let recs=[...activeData];
  if(activeFilter!=='all') recs=recs.filter(r=>r.subred===activeFilter);
  if(statusFilter) recs=recs.filter(r=>{
    const st=getShiftStatus(r.inicio);
    if(statusFilter==='frozen') return st==='frozen';
    if(statusFilter==='warn')   return st==='warn';
    if(statusFilter==='dob')    return st==='dob'||getDobladoInfo(r).maxTurnos>=2;
    if(statusFilter==='crit')   return st==='crit';
    return true;
  });
  if(searchQuery) recs=recs.filter(r=>(r.placa||'').toUpperCase().includes(searchQuery.toUpperCase())||(r.con_nombre||'').toLowerCase().includes(searchQuery.toLowerCase()));
  recs.sort((a,b)=>getHoursRaw(b.inicio)-getHoursRaw(a.inicio));

  const empty=document.getElementById('main-empty');
  const tbody=document.getElementById('main-tbody');
  if(!recs.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';

  tbody.innerHTML=recs.map(r=>{
    const st     = getShiftStatus(r.inicio);
    const h      = getHoursRaw(r.inicio);
    const dInfo  = getDobladoInfo(r);
    const relay  = hasRelay(r);
    const rowCls = st==='crit'?'r-crit':st==='frozen'?'r-frozen':st==='warn'?'r-warn':'';

    const timeLabel = st==='frozen'
      ? `<span class="hours-tag frozen">‚ùÑ 12:00 ‚Äî Esperando relevo</span>`
      : `<span class="hours-tag ${st}">${Math.floor(h)}h ${Math.round((h%1)*60)}m</span>`;

    const statusLabel = st==='crit'?'üî¥ DETENER':st==='frozen'?'üü£ RELEVO PENDIENTE':st==='warn'?'üü° Por vencer':'‚úÖ Normal';

    const personHTML = dInfo.doblados.length
      ? dInfo.doblados.map(p=>`<span class="b-doblado ${p.turnos>=3?'d2':'d1'}">üü† ${p.rol} ‚Äî ${p.turnos}¬∞ turno</span>`).join('<br>')
      : '<span style="font-size:0.7rem;color:var(--green)">‚úÖ Normal</span>';

    const medCell = r.med_nombre
      ? `<div class="person-block"><span class="person-name">${r.med_nombre}</span><span class="person-doc">${r.med_cedula||'‚Äî'}</span>${r.med_foto_url?`<a href="${r.med_foto_url}" target="_blank" class="photo-link">üì∑ Ver foto</a>`:''}</div>`
      : `<span class="na-tag">N/A</span>`;

    const conCell = `<div class="person-block"><span class="person-name">${r.con_nombre||'‚Äî'}</span><span class="person-doc">${r.con_cedula||'‚Äî'}</span>${r.con_foto_url?`<a href="${r.con_foto_url}" target="_blank" class="photo-link">üì∑ Ver foto</a>`:''}</div>`;
    const auxCell = `<div class="person-block"><span class="person-name">${r.aux_nombre||'‚Äî'}</span><span class="person-doc">${r.aux_cedula||'‚Äî'}</span>${r.aux_foto_url?`<a href="${r.aux_foto_url}" target="_blank" class="photo-link">üì∑ Ver foto</a>`:''}</div>`;

    let btn;
    if(st==='crit')   btn=`<button class="btn-action btn-detener" onclick="openModal('${r.id}','detener')">üõë Detener</button>`;
    else if(st==='frozen') btn=`<button class="btn-action btn-relay" onclick="openModal('${r.id}','relevo')">üü£ Sin relevo</button>`;
    else              btn=`<button class="btn-action btn-cerrar" onclick="openModal('${r.id}','cerrar')">‚úì Cerrar</button>`;

    return `<tr class="${rowCls}">
      <td><span class="b-subred ${subClass(r.subred)}">${r.subred}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:600">${r.placa}</td>
      <td><span class="b-tipo">${r.tipo}</span></td>
      <td>${medCell}</td>
      <td>${conCell}</td>
      <td>${auxCell}</td>
      <td style="font-size:0.72rem;color:var(--text-sub)">${r.turno}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.69rem;color:var(--text-sub)">${fmtDate(r.inicio)}</td>
      <td>${timeLabel}</td>
      <td><span class="status-chip ${st}">${statusLabel}</span></td>
      <td>${personHTML}</td>
      <td style="font-size:0.72rem;color:var(--text-muted)">${r.referente||'‚Äî'}</td>
      <td>${btn}</td>
    </tr>`;
  }).join('');
}

function renderSubredes() {
  const subredes=[{name:'Norte',color:'#60A5FA'},{name:'Sur',color:'#4ADE80'},{name:'Sur Occidente',color:'#FCD34D'},{name:'Centro Oriente',color:'#C084FC'}];
  document.getElementById('subred-grid').innerHTML=subredes.map(s=>{
    const rows=activeData.filter(r=>r.subred===s.name).sort((a,b)=>getHoursRaw(b.inicio)-getHoursRaw(a.inicio));
    const counts={ok:0,warn:0,frozen:0,dob:0,crit:0};
    rows.forEach(r=>{const st=getShiftStatus(r.inicio);counts[st]=(counts[st]||0)+1;});

    const rowsHTML=rows.length?rows.map(r=>{
      const st=getShiftStatus(r.inicio);
      const h=getHoursRaw(r.inicio);
      const dInfo=getDobladoInfo(r);
      const timeStr=st==='frozen'?'‚ùÑ 12:00':`${Math.floor(h)}h ${Math.round((h%1)*60)}m`;
      return `<div class="subred-row ${st==='crit'?'r-crit':st==='frozen'?'r-frozen':st==='warn'?'r-warn':''}">
        <div class="subred-row-top">
          <span class="subred-row-placa">${r.placa}</span>
          <span class="b-tipo">${r.tipo}</span>
          <span class="hours-tag ${st}" style="margin-left:auto">${timeStr}</span>
        </div>
        <div class="subred-row-people">
          ${r.med_nombre?`<div class="subred-row-person"><span class="srp-role med">M√©dico</span><span class="srp-name">${r.med_nombre}</span></div>`:''}
          <div class="subred-row-person"><span class="srp-role con">Conductor</span><span class="srp-name">${r.con_nombre}</span><span class="srp-doc">${r.con_cedula}</span>${dInfo.doblados.find(d=>d.cedula===r.con_cedula)?`<span class="b-doblado d1">DOBLADO</span>`:''}</div>
          <div class="subred-row-person"><span class="srp-role aux">Auxiliar</span><span class="srp-name">${r.aux_nombre}</span><span class="srp-doc">${r.aux_cedula}</span>${dInfo.doblados.find(d=>d.cedula===r.aux_cedula)?`<span class="b-doblado d1">DOBLADO</span>`:''}</div>
        </div>
      </div>`;
    }).join(''):`<div style="text-align:center;padding:1.5rem;color:var(--text-muted);font-size:0.8rem">Sin m√≥viles activas</div>`;

    return `<div class="subred-panel">
      <div class="subred-panel-head">
        <div class="subred-panel-dot" style="background:${s.color}"></div>
        <div class="subred-panel-name" style="color:${s.color}">Subred ${s.name}</div>
        <div class="subred-panel-count">
          ${counts.ok?`<span class="mini-count ok">${counts.ok} ok</span>`:''}
          ${counts.warn?`<span class="mini-count warn">${counts.warn} venc</span>`:''}
          ${counts.frozen?`<span class="mini-count frozen">${counts.frozen} ‚ùÑ</span>`:''}
          ${counts.crit?`<span class="mini-count crit">${counts.crit} crit</span>`:''}
        </div>
      </div>
      <div class="subred-panel-body">${rowsHTML}</div>
    </div>`;
  }).join('');
}

function renderHistorial() {
  const now=new Date();
  let recs=[...closedData];
  const startOf=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x;};
  const endOf  =d=>{const x=new Date(d);x.setHours(23,59,59,999);return x;};
  if(dayFilter==='today'){const s=startOf(now),e=endOf(now);recs=recs.filter(r=>{const d=new Date(r.cierre||r.inicio);return d>=s&&d<=e;});}
  else if(dayFilter==='yesterday'){const y=new Date(now);y.setDate(y.getDate()-1);recs=recs.filter(r=>{const d=new Date(r.cierre||r.inicio);return d>=startOf(y)&&d<=endOf(y);});}
  else if(dayFilter==='week'){const s=new Date(now);s.setDate(s.getDate()-7);recs=recs.filter(r=>new Date(r.cierre||r.inicio)>=s);}
  else if(dayFilter==='custom'){const from=document.getElementById('date-from').value,to=document.getElementById('date-to').value;if(from)recs=recs.filter(r=>new Date(r.cierre||r.inicio)>=new Date(from));if(to)recs=recs.filter(r=>new Date(r.cierre||r.inicio)<=endOf(new Date(to)));}

  const tbody=document.getElementById('hist-tbody'),empty=document.getElementById('hist-empty');
  if(!recs.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';

  tbody.innerHTML=[...recs].reverse().map(r=>{
    const total=r.cierre?((new Date(r.cierre)-new Date(r.inicio))/3600000):0;
    const st=total>24?'crit':total>12?'dob':total>=11?'warn':'ok';
    return `<tr class="closed-row">
      <td style="font-size:0.7rem">${fmtDateShort(r.cierre||r.inicio)}</td>
      <td><span class="b-subred ${subClass(r.subred)}">${r.subred}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.78rem;font-weight:600">${r.placa}</td>
      <td><span class="b-tipo">${r.tipo}</span></td>
      <td style="font-size:0.76rem">${r.con_nombre}</td>
      <td style="font-size:0.76rem">${r.aux_nombre}</td>
      <td style="font-size:0.76rem">${r.med_nombre||'N/A'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.7rem">${fmtDate(r.inicio)}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.7rem">${fmtDate(r.cierre)}</td>
      <td><span class="hours-tag ${st}">${Math.floor(total)}h ${Math.round((total%1)*60)}m</span></td>
      <td style="font-size:0.73rem;font-weight:700;color:${r.accion==='detener'?'var(--red)':r.accion==='relevo'?'var(--frozen)':'var(--green)'}">${r.accion==='detener'?'üõë DETENIDA':r.accion==='relevo'?'üü£ SIN RELEVO':'‚úì Normal'}</td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
function setFilter(val,btn){activeFilter=val;statusFilter=null;searchQuery='';document.querySelectorAll('#toolbar .filter-chip').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.getElementById('search-box').value='';renderTable();}
function setStatusFilter(type,btn){statusFilter=statusFilter===type?null:type;activeFilter='all';document.querySelectorAll('#toolbar .filter-chip').forEach(b=>b.classList.remove('active'));if(statusFilter)btn.classList.add('active');else document.querySelector('#toolbar .filter-chip').classList.add('active');renderTable();}
function searchFilter(v){searchQuery=v;renderTable();}
function setDayFilter(type,btn){dayFilter=type;document.querySelectorAll('.day-chip').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');renderHistorial();}
function showTab(name,btn){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+name).classList.add('active');btn.classList.add('active');}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(id, action) {
  const r=activeData.find(x=>String(x.id)===String(id));
  if(!r) return;
  pendingAction={id,action,record:r};
  const h=getHoursRaw(r.inicio);
  const dInfo=getDobladoInfo(r);
  const st=getShiftStatus(r.inicio);

  document.getElementById('modal-title').textContent = action==='detener'?'üõë Detener M√≥vil':action==='relevo'?'üü£ Cerrar ‚Äî Sin Relevo':'‚úì Cerrar Turno';
  document.getElementById('modal-sub').textContent   = action==='detener'
    ? `Esta m√≥vil lleva m√°s de 24h activa.`
    : action==='relevo'
    ? `El turno de 12h termin√≥ y no hubo relevo. Al cerrar, el personal sale del listado.`
    : `Confirme el cierre del turno de ${Math.floor(h)}h ${Math.round((h%1)*60)}m.`;

  const dobWarn=document.getElementById('modal-dob-warn');
  dobWarn.style.display=dInfo.doblados.length?'block':'none';
  if(dInfo.doblados.length) dobWarn.innerHTML=`‚ö†Ô∏è <strong>Personal doblando:</strong><br>`+dInfo.doblados.map(p=>`${p.rol}: ${p.nombre} ‚Äî ${p.turnos}¬∞ turno`).join('<br>');

  const frozenWarn=document.getElementById('modal-frozen-warn');
  frozenWarn.style.display=st==='frozen'?'block':'none';
  if(st==='frozen') frozenWarn.innerHTML=`üü£ <strong>Turno congelado en 12:00</strong> ‚Äî No se registr√≥ relevo para esta m√≥vil.`;

  document.getElementById('modal-detail').innerHTML=
    `<strong>${r.placa} ¬∑ ${r.tipo} ¬∑ Subred ${r.subred}</strong>
    Conductor: ${r.con_nombre} (CC ${r.con_cedula})<br>
    Auxiliar: ${r.aux_nombre} (CC ${r.aux_cedula})<br>
    ${r.med_nombre?'M√©dico: '+r.med_nombre+'<br>':''}
    Inicio: ${fmtDate(r.inicio)}`;

  const btn=document.getElementById('modal-confirm-btn');
  btn.textContent = action==='detener'?'üõë Confirmar ‚Äî Detener':action==='relevo'?'üü£ Confirmar ‚Äî Sin Relevo':'‚úì Confirmar Cierre';
  btn.className   = action==='detener'?'btn-modal-detener':'btn-modal-confirm';
  btn.onclick     = confirmAction;
  document.getElementById('modal-overlay').classList.add('open');
}

async function confirmAction() {
  if(!pendingAction) return;
  const btn=document.getElementById('modal-confirm-btn');
  btn.innerHTML='<span class="spinner"></span>Guardando...'; btn.disabled=true;
  await closeRecord(pendingAction.id, pendingAction.action, pendingAction.record);
  btn.disabled=false; closeModal();
}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');pendingAction=null;}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportExcel(){
  const recs=[...activeData].sort((a,b)=>getHoursRaw(b.inicio)-getHoursRaw(a.inicio));
  const headers=['Subred','Placa','Tipo','Turno','Inicio','Tiempo','Estado','M√©dico','Ced.Med','Conductor','Ced.Con','Auxiliar','Ced.Aux','Referente','Observaciones'];
  const rows=recs.map(r=>{
    const h=getHoursRaw(r.inicio);const st=getShiftStatus(r.inicio);
    const stLabel=st==='crit'?'DETENER':st==='frozen'?'RELEVO PENDIENTE':st==='warn'?'POR VENCER':'Normal';
    return [r.subred,r.placa,r.tipo,r.turno,fmtDate(r.inicio),`${Math.floor(h)}h ${Math.round((h%1)*60)}m`,stLabel,r.med_nombre||'N/A',r.med_cedula||'',r.con_nombre,r.con_cedula,r.aux_nombre,r.aux_cedula,r.referente||'‚Äî',r.observaciones||''];
  });
  downloadCSV([headers,...rows],`SCAT_Activas_${todayStr()}`);
}
function exportHistorialExcel(){
  const headers=['Fecha','Subred','Placa','Tipo','Inicio','Cierre','Total Horas','Conductor','Auxiliar','M√©dico','Resultado'];
  const rows=[...closedData].reverse().map(r=>{
    const total=r.cierre?((new Date(r.cierre)-new Date(r.inicio))/3600000):0;
    return [fmtDateShort(r.cierre||r.inicio),r.subred,r.placa,r.tipo,fmtDate(r.inicio),fmtDate(r.cierre),`${Math.floor(total)}h ${Math.round((total%1)*60)}m`,r.con_nombre,r.aux_nombre,r.med_nombre||'N/A',r.accion==='detener'?'DETENIDA':r.accion==='relevo'?'SIN RELEVO':'Normal'];
  });
  downloadCSV([headers,...rows],`SCAT_Historial_${todayStr()}`);
}
function downloadCSV(rows,name){
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name+'.csv';a.click();
}
function exportTxt(){
  const recs=[...activeData].sort((a,b)=>getHoursRaw(b.inicio)-getHoursRaw(a.inicio));
  let txt=`REPORTE SCAT ‚Äî ${new Date().toLocaleString('es-CO')}\n${'‚ïê'.repeat(60)}\nIng. Edisson Mac√≠as ¬∑ Secretar√≠a de Salud Bogot√°\n\n`;
  ['Norte','Sur','Sur Occidente','Centro Oriente'].forEach(s=>{
    const rows=recs.filter(r=>r.subred===s);
    txt+=`SUBRED ${s.toUpperCase()} (${rows.length})\n${'‚îÄ'.repeat(40)}\n`;
    rows.forEach(r=>{
      const h=getHoursRaw(r.inicio);const st=getShiftStatus(r.inicio);
      const icon=st==='crit'?'üî¥':st==='frozen'?'üü£':st==='warn'?'üü°':'‚úÖ';
      const timeStr=st==='frozen'?'‚ùÑ 12:00 ‚Äî Esperando relevo':`${Math.floor(h)}h ${Math.round((h%1)*60)}m`;
      txt+=`\n  ${icon} ${r.placa} (${r.tipo}) ¬∑ ${timeStr}\n`;
      if(r.med_nombre) txt+=`  M√©dico:    ${r.med_nombre} ¬∑ CC ${r.med_cedula}\n`;
      txt+=`  Conductor: ${r.con_nombre} ¬∑ CC ${r.con_cedula}\n`;
      txt+=`  Auxiliar:  ${r.aux_nombre} ¬∑ CC ${r.aux_cedula}\n`;
    });
    txt+='\n';
  });
  const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Reporte_${todayStr()}.txt`;a.click();
}

function showLoading(msg){document.getElementById('loading-text').textContent=msg||'Cargando...';document.getElementById('loading-overlay').classList.add('show');}
function hideLoading(){document.getElementById('loading-overlay').classList.remove('show');}
</script>
</body>
</html>
