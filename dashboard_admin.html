<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCAT ¬∑ Panel Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060B18;--bg2:#0C1426;--sur:#0F1D35;--sur2:#162440;
  --bdr:#1E3050;--bdr2:#243B5E;
  --acc:#3B82F6;--accg:rgba(59,130,246,.2);
  --grn:#22C55E;--grnd:rgba(34,197,94,.12);
  --yel:#F59E0B;--yeld:rgba(245,158,11,.12);
  --org:#F97316;--orgd:rgba(249,115,22,.12);
  --red:#EF4444;--redd:rgba(239,68,68,.12);
  --prp:#8B5CF6;--prpd:rgba(139,92,246,.12);
  --txt:#F1F5F9;--sub:#94A3B8;--mut:#4A6080;
  --n:#60A5FA;--s:#4ADE80;--so:#FCD34D;--co:#C084FC;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;width:100%;}

/* PIN */
.pin-scr{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;}
.pin-scr.off{display:none;}
.pin-logo{font-size:3rem;margin-bottom:.5rem;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pin-title{font-size:1.35rem;font-weight:800;text-align:center;margin-bottom:3px;}
.pin-author{font-size:.72rem;color:var(--acc);font-weight:600;margin-bottom:3px;text-align:center;}
.pin-sub{font-size:.76rem;color:var(--sub);text-align:center;margin-bottom:1.5rem;line-height:1.5;}
.pin-box{background:var(--sur);border:1px solid var(--bdr2);border-radius:20px;padding:1.8rem;width:100%;max-width:340px;box-shadow:0 24px 80px rgba(0,0,0,.5);}
.pin-lbl{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--sub);margin-bottom:10px;text-align:center;}
.pin-inputs{display:flex;gap:10px;justify-content:center;margin-bottom:1.2rem;}
.pin-d{width:50px;height:58px;background:var(--bg2);border:2px solid var(--bdr);border-radius:12px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--txt);outline:none;caret-color:var(--acc);}
.pin-d:focus{border-color:var(--acc);box-shadow:0 0 0 4px var(--accg);}
.btn-pin{width:100%;padding:13px;background:var(--acc);border:none;border-radius:12px;color:#fff;font-family:'Outfit',sans-serif;font-size:.93rem;font-weight:700;cursor:pointer;}
.pin-err{text-align:center;margin-top:9px;font-size:.78rem;color:var(--red);font-weight:600;display:none;}
.pin-credit{font-size:.63rem;color:var(--mut);text-align:center;margin-top:1rem;line-height:1.5;}
.pin-credit strong{color:var(--acc);}

/* APP */
.app{display:none;width:100%;}
.app.on{display:block;}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:rgba(6,11,24,.96);backdrop-filter:blur(20px);border-bottom:1px solid var(--bdr);height:54px;display:flex;align-items:center;padding:0 1.4rem;gap:.8rem;}
.t-logo{font-size:.9rem;font-weight:800;display:flex;align-items:center;gap:7px;white-space:nowrap;}
.t-badge{background:var(--acc);color:#fff;font-size:.56rem;font-weight:700;padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:.06em;}
.t-tabs{display:flex;gap:3px;margin-left:.4rem;}
.tab{padding:5px 11px;border-radius:8px;border:none;background:none;color:var(--sub);font-family:'Outfit',sans-serif;font-size:.76rem;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.tab:hover{background:var(--sur2);color:var(--txt);}
.tab.on{background:var(--sur2);color:var(--acc);border:1px solid var(--bdr2);}
.t-right{margin-left:auto;display:flex;align-items:center;gap:7px;}
.live{width:7px;height:7px;border-radius:50%;background:var(--grn);box-shadow:0 0 8px var(--grn);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.clk{font-family:'JetBrains Mono',monospace;font-size:.76rem;color:var(--sub);background:var(--sur);border:1px solid var(--bdr);padding:3px 8px;border-radius:6px;}
.synctag{font-size:.63rem;color:var(--mut);font-family:'JetBrains Mono',monospace;}
.tbtn{padding:4px 9px;background:none;border:1px solid var(--bdr);border-radius:6px;color:var(--mut);font-size:.7rem;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s;}
.tbtn:hover{border-color:var(--acc);color:var(--acc);}
.tbtn.out:hover{border-color:var(--red);color:var(--red);}

/* VIEWS */
.view{display:none;padding:1.4rem;min-height:calc(100vh - 54px);width:100%;}
.view.on{display:block;}

/* ALERTS */
.abanner{display:none;border-radius:12px;padding:11px 15px;margin-bottom:1rem;align-items:center;gap:12px;}
.abanner.show{display:flex;}
.abanner.red{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.35);}
.abanner.org{background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.35);}
.abanner.prp{background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.35);}
.ab-txt{flex:1;font-size:.78rem;line-height:1.5;}
.ab-txt strong{display:block;font-size:.86rem;margin-bottom:2px;}
.abanner.red .ab-txt strong{color:var(--red);}
.abanner.org .ab-txt strong{color:var(--org);}
.abanner.prp .ab-txt strong{color:var(--prp);}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:.9rem;margin-bottom:1.4rem;}
.kpi{background:var(--sur);border:1px solid var(--bdr);border-radius:14px;padding:.9rem 1rem;position:relative;overflow:hidden;}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;}
.kpi.k0::after{background:var(--acc);}
.kpi.k1::after{background:var(--grn);}
.kpi.k2::after{background:var(--yel);}
.kpi.k3::after{background:var(--prp);}
.kpi.k4::after{background:var(--org);animation:pb 2s infinite;}
.kpi.k5::after{background:var(--red);animation:pb 2s infinite;}
@keyframes pb{0%,100%{opacity:1}50%{opacity:.35}}
.kn{font-family:'JetBrains Mono',monospace;font-size:1.9rem;font-weight:600;line-height:1;}
.kpi.k0 .kn{color:var(--acc);} .kpi.k1 .kn{color:var(--grn);}
.kpi.k2 .kn{color:var(--yel);} .kpi.k3 .kn{color:var(--prp);}
.kpi.k4 .kn{color:var(--org);} .kpi.k5 .kn{color:var(--red);}
.kl{font-size:.63rem;font-weight:600;color:var(--mut);text-transform:uppercase;letter-spacing:.06em;margin-top:5px;}
.ks{font-size:.58rem;color:var(--mut);margin-top:2px;}

/* TOOLBAR */
.tbar{display:flex;align-items:center;gap:7px;margin-bottom:.9rem;flex-wrap:wrap;}
.chip{padding:4px 11px;border-radius:20px;border:1px solid var(--bdr);background:none;color:var(--mut);font-size:.7rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:'Outfit',sans-serif;}
.chip:hover{border-color:var(--acc);color:var(--acc);}
.chip.on{background:var(--acc);border-color:var(--acc);color:#fff;}
.chip.cn.on{background:var(--n);border-color:var(--n);color:#000;}
.chip.cs.on{background:var(--s);border-color:var(--s);color:#000;}
.chip.cso.on{background:var(--so);border-color:var(--so);color:#000;}
.chip.cco.on{background:var(--co);border-color:var(--co);color:#000;}
.chip.cy.on{background:var(--yel);border-color:var(--yel);color:#000;}
.chip.cp.on{background:var(--prp);border-color:var(--prp);color:#fff;}
.chip.cod.on{background:var(--org);border-color:var(--org);color:#000;}
.chip.cr.on{background:var(--red);border-color:var(--red);color:#fff;}
.srch{padding:5px 10px;background:var(--sur);border:1px solid var(--bdr);border-radius:8px;color:var(--txt);font-family:'Outfit',sans-serif;font-size:.76rem;width:130px;}
.srch:focus{outline:none;border-color:var(--acc);}
.spc{flex:1;}
.expbtn{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:8px;border:1px solid var(--bdr);background:var(--sur);color:var(--sub);font-size:.7rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;}
.expbtn:hover{border-color:var(--acc);color:var(--acc);}

/* TABLE */
.twrap{overflow-x:auto;border-radius:14px;border:1px solid var(--bdr);width:100%;}
table{width:100%;border-collapse:collapse;font-size:.77rem;min-width:980px;}
thead th{background:var(--sur2);padding:8px 10px;text-align:left;font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--mut);white-space:nowrap;border-bottom:1px solid var(--bdr);}
tbody tr{border-bottom:1px solid rgba(30,48,80,.5);transition:background .15s;}
tbody tr:hover{background:rgba(255,255,255,.02);}
tbody tr.rc{background:rgba(239,68,68,.05);}
tbody tr.rc td:first-child{border-left:3px solid var(--red);}
tbody tr.rd{background:rgba(249,115,22,.05);}
tbody tr.rd td:first-child{border-left:3px solid var(--org);}
tbody tr.rw{background:rgba(245,158,11,.05);}
tbody tr.rw td:first-child{border-left:3px solid var(--yel);}
tbody tr.rf{background:rgba(139,92,246,.05);}
tbody tr.rf td:first-child{border-left:3px solid var(--prp);}
td{padding:9px 10px;vertical-align:middle;}

/* BADGES */
.bsub{padding:3px 8px;border-radius:20px;font-size:.62rem;font-weight:700;display:inline-block;white-space:nowrap;}
.bsub.bn{background:rgba(96,165,250,.12);color:var(--n);border:1px solid rgba(96,165,250,.25);}
.bsub.bs{background:rgba(74,222,128,.12);color:var(--s);border:1px solid rgba(74,222,128,.25);}
.bsub.bso{background:rgba(252,211,77,.12);color:var(--so);border:1px solid rgba(252,211,77,.25);}
.bsub.bco{background:rgba(192,132,252,.12);color:var(--co);border:1px solid rgba(192,132,252,.25);}
.btp{padding:2px 7px;border-radius:4px;font-size:.58rem;font-weight:700;background:var(--sur2);color:var(--mut);border:1px solid var(--bdr);}
.htag{font-family:'JetBrains Mono',monospace;font-size:.74rem;font-weight:600;padding:3px 8px;border-radius:6px;display:inline-block;white-space:nowrap;}
.htag.ok{background:var(--grnd);color:var(--grn);}
.htag.warn{background:var(--yeld);color:var(--yel);}
.htag.dob{background:var(--orgd);color:var(--org);}
.htag.crit{background:var(--redd);color:var(--red);animation:gr 2s infinite;}
.htag.frz{background:var(--prpd);color:var(--prp);animation:gp 2s infinite;}
@keyframes gr{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(239,68,68,.4)}}
@keyframes gp{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(139,92,246,.5)}}
.stchip{font-size:.63rem;font-weight:700;padding:3px 8px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;white-space:nowrap;}
.stchip.ok{background:var(--grnd);color:var(--grn);}
.stchip.warn{background:var(--yeld);color:var(--yel);}
.stchip.dob{background:var(--orgd);color:var(--org);}
.stchip.crit{background:var(--redd);color:var(--red);}
.stchip.frz{background:var(--prpd);color:var(--prp);}
.pblock{display:flex;flex-direction:column;gap:1px;}
.pname{font-weight:500;font-size:.77rem;color:var(--txt);white-space:nowrap;}
.pdoc{font-family:'JetBrains Mono',monospace;font-size:.59rem;color:var(--mut);}
.pfoto{font-size:.59rem;color:var(--acc);text-decoration:none;display:block;margin-top:2px;}
.pfoto:hover{text-decoration:underline;}
.na{color:var(--mut);font-size:.68rem;}
.dbadge{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:.57rem;font-weight:800;text-transform:uppercase;white-space:nowrap;}
.dbadge.d1{background:var(--orgd);color:var(--org);border:1px solid rgba(249,115,22,.3);}
.dbadge.d2{background:var(--redd);color:var(--red);border:1px solid rgba(239,68,68,.3);}
.abtn{padding:4px 9px;border-radius:6px;border:none;font-size:.67rem;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s;white-space:nowrap;}
.abtn.close{background:var(--sur2);color:var(--sub);border:1px solid var(--bdr);}
.abtn.close:hover{border-color:var(--grn);color:var(--grn);}
.abtn.stop{background:var(--redd);color:var(--red);border:1px solid rgba(239,68,68,.3);}
.abtn.relay{background:var(--prpd);color:var(--prp);border:1px solid rgba(139,92,246,.3);}

/* SUBREDES */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:1.4rem;}
.spanel{background:var(--sur);border:1px solid var(--bdr);border-radius:16px;overflow:hidden;}
.spanel-hd{padding:12px 15px;display:flex;align-items:center;gap:9px;border-bottom:1px solid var(--bdr);}
.spanel-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.spanel-name{font-size:.86rem;font-weight:700;}
.spanel-counts{margin-left:auto;display:flex;gap:4px;}
.mc{font-size:.58rem;font-weight:700;padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;}
.mc.ok{background:var(--grnd);color:var(--grn);}
.mc.warn{background:var(--yeld);color:var(--yel);}
.mc.frz{background:var(--prpd);color:var(--prp);}
.mc.crit{background:var(--redd);color:var(--red);}
.spanel-body{padding:9px;}
.srow{background:var(--bg2);border:1px solid var(--bdr);border-radius:10px;padding:9px 11px;margin-bottom:7px;}
.srow:last-child{margin-bottom:0;}
.srow.rc{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.04);}
.srow.rf{border-color:rgba(139,92,246,.35);background:rgba(139,92,246,.04);}
.srow.rw{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.04);}
.srow-top{display:flex;align-items:center;gap:7px;margin-bottom:5px;flex-wrap:wrap;}
.srow-placa{font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:600;}
.srow-people{display:flex;flex-direction:column;gap:3px;font-size:.71rem;}
.sp-row{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
.sp-role{font-weight:700;min-width:56px;}
.sp-role.med{color:var(--n);}.sp-role.con{color:var(--s);}.sp-role.aux{color:var(--co);}
.sp-name{color:var(--sub);}
.sp-doc{font-family:'JetBrains Mono',monospace;font-size:.59rem;color:var(--mut);}

/* HISTORIAL */
.hbar{display:flex;align-items:center;gap:9px;margin-bottom:.9rem;flex-wrap:wrap;}
.dinput{padding:5px 10px;background:var(--sur);border:1px solid var(--bdr);border-radius:8px;color:var(--txt);font-family:'Outfit',sans-serif;font-size:.76rem;}
.dinput:focus{outline:none;border-color:var(--acc);}

/* MODAL */
.modal{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.modal.open{display:flex;}
.mbox{background:var(--sur);border:1px solid var(--bdr2);border-radius:20px;padding:1.6rem;width:100%;max-width:400px;box-shadow:0 32px 80px rgba(0,0,0,.6);animation:sup .3s ease;}
@keyframes sup{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.m-title{font-size:1rem;font-weight:800;margin-bottom:5px;}
.m-sub{font-size:.76rem;color:var(--sub);margin-bottom:1rem;}
.m-detail{background:var(--bg2);border:1px solid var(--bdr);border-radius:9px;padding:10px 12px;font-size:.78rem;color:var(--sub);line-height:1.7;margin-bottom:.9rem;}
.m-detail strong{color:var(--txt);display:block;margin-bottom:3px;}
.m-warn{border-radius:8px;padding:8px 11px;margin-bottom:.8rem;font-size:.74rem;line-height:1.5;}
.m-warn.org{background:var(--orgd);border:1px solid rgba(249,115,22,.3);color:var(--org);}
.m-warn.prp{background:var(--prpd);border:1px solid rgba(139,92,246,.3);color:var(--prp);}
.m-btns{display:flex;gap:9px;}
.m-cancel{flex:1;padding:10px;background:none;border:1px solid var(--bdr);border-radius:9px;color:var(--sub);cursor:pointer;font-family:'Outfit',sans-serif;font-weight:600;font-size:.81rem;}
.m-ok{flex:2;padding:10px;background:var(--grn);border:none;border-radius:9px;color:#fff;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;font-size:.81rem;}
.m-ok.red{background:var(--red);}

/* LOADING */
.lov{display:none;position:fixed;inset:0;z-index:500;background:rgba(6,11,24,.7);backdrop-filter:blur(4px);align-items:center;justify-content:center;flex-direction:column;gap:14px;}
.lov.show{display:flex;}
.lring{width:42px;height:42px;border:3px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.ltxt{font-size:.8rem;color:var(--sub);}
.spin{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;margin-right:5px;}

.empty{text-align:center;padding:3rem;color:var(--mut);font-size:.82rem;}
.closed-r{opacity:.6;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:3px;}
.footer{text-align:center;padding:14px;font-size:.61rem;color:var(--mut);border-top:1px solid var(--bdr);}
.footer strong{color:var(--acc);}

@media(max-width:900px){.kpi-row{grid-template-columns:repeat(3,1fr);}.sgrid{grid-template-columns:1fr;}}
@media(max-width:600px){.kpi-row{grid-template-columns:repeat(2,1fr);}.view{padding:1rem;}.topbar{padding:0 .9rem;gap:4px;}.t-tabs{gap:2px;}.tab{font-size:.68rem;padding:4px 7px;}}
</style>
</head>
<body>

<!-- PIN -->
<div class="pin-scr" id="pin-scr">
  <div class="pin-logo">üöë</div>
  <div class="pin-title">SCAT ¬∑ Panel de Control</div>
  <div class="pin-author">Ing. Edisson Mac√≠as</div>
  <div class="pin-sub">Secretar√≠a de Salud ¬∑ Bogot√° D.C.<br>Sistema de Control de Ambulancias y Turnos</div>
  <div class="pin-box">
    <div class="pin-lbl">Ingrese su clave de acceso</div>
    <div class="pin-inputs">
      <input class="pin-d" type="password" maxlength="1" inputmode="numeric" id="p1">
      <input class="pin-d" type="password" maxlength="1" inputmode="numeric" id="p2">
      <input class="pin-d" type="password" maxlength="1" inputmode="numeric" id="p3">
      <input class="pin-d" type="password" maxlength="1" inputmode="numeric" id="p4">
    </div>
    <button class="btn-pin" onclick="checkPin()">INGRESAR ‚Üí</button>
    <div class="pin-err" id="pin-err">Clave incorrecta. Intente de nuevo.</div>
  </div>
  <div class="pin-credit">Sistema SCAT v2.0 ¬∑ <strong>Ing. Edisson Mac√≠as</strong><br>Secretar√≠a de Salud Bogot√° ¬∑ 2026</div>
</div>

<!-- LOADING -->
<div class="lov" id="lov"><div class="lring"></div><div class="ltxt" id="ltxt">Cargando...</div></div>

<!-- APP -->
<div class="app" id="app">
  <header class="topbar">
    <div class="t-logo">üöë SCAT <span class="t-badge">Admin</span></div>
    <nav class="t-tabs">
      <button class="tab on" onclick="showTab('dash',this)">üìä Dashboard</button>
      <button class="tab" onclick="showTab('subs',this)">üìç Subredes</button>
      <button class="tab" onclick="showTab('hist',this)">üìã Historial</button>
    </nav>
    <div class="t-right">
      <div class="live"></div>
      <span class="synctag" id="synctag">--</span>
      <div class="clk" id="clk">--:--</div>
      <button class="tbtn" onclick="forceRefresh()">‚ü≥ Sync</button>
      <button class="tbtn out" onclick="logout()">Salir</button>
    </div>
  </header>

  <!-- DASHBOARD -->
  <div class="view on" id="tab-dash">
    <div class="abanner red" id="ab-crit"><div>‚õî</div><div class="ab-txt"><strong id="ab-crit-t"></strong><span id="ab-crit-m"></span></div></div>
    <div class="abanner org" id="ab-dob"><div>‚ö†Ô∏è</div><div class="ab-txt"><strong id="ab-dob-t"></strong><span id="ab-dob-m"></span></div></div>
    <div class="abanner prp" id="ab-frz"><div>üü£</div><div class="ab-txt"><strong id="ab-frz-t"></strong><span id="ab-frz-m"></span></div></div>
    <div class="kpi-row" id="kpis"></div>
    <div class="tbar" id="tbar">
      <button class="chip on" onclick="setF('all',this)">Todas</button>
      <button class="chip cn" onclick="setF('Norte',this)">Norte</button>
      <button class="chip cs" onclick="setF('Sur',this)">Sur</button>
      <button class="chip cso" onclick="setF('Sur Occidente',this)">Sur Occ.</button>
      <button class="chip cco" onclick="setF('Centro Oriente',this)">Centro Or.</button>
      <button class="chip cy" onclick="setSF('warn',this)">üü° Por vencer</button>
      <button class="chip cp" onclick="setSF('frz',this)">üü£ Relevo</button>
      <button class="chip cod" onclick="setSF('dob',this)">üü† Doblados</button>
      <button class="chip cr" onclick="setSF('crit',this)">üî¥ Cr√≠ticos</button>
      <input class="srch" type="text" placeholder="üîç Placa..." oninput="setSearch(this.value)" id="srch">
      <div class="spc"></div>
      <button class="expbtn" onclick="exportCsv()">üìä Excel</button>
      <button class="expbtn" onclick="exportTxt()">‚¨á Texto</button>
    </div>
    <div class="twrap">
      <table>
        <thead><tr>
          <th>Subred</th><th>Placa</th><th>Tipo</th>
          <th>M√©dico</th><th>Conductor</th><th>Auxiliar</th>
          <th>Turno</th><th>Inicio</th><th>Tiempo</th>
          <th>Estado</th><th>Personal</th><th>Acci√≥n</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="empty" id="empty" style="display:none">
        <div style="font-size:2.2rem;margin-bottom:8px">üöë</div>
        No hay m√≥viles activas con estos filtros
      </div>
    </div>
  </div>

  <!-- SUBREDES -->
  <div class="view" id="tab-subs">
    <div class="sgrid" id="sgrid"></div>
  </div>

  <!-- HISTORIAL -->
  <div class="view" id="tab-hist">
    <div class="hbar">
      <div style="font-size:1rem;font-weight:700;margin-right:4px">Historial de Turnos</div>
      <button class="chip on" onclick="setDF('hoy',this)">Hoy</button>
      <button class="chip" onclick="setDF('ayer',this)">Ayer</button>
      <button class="chip" onclick="setDF('sem',this)">Esta semana</button>
      <button class="chip" onclick="setDF('todo',this)">Todo</button>
      <input class="dinput" type="date" id="dfrom" onchange="setDF('custom',null)">
      <input class="dinput" type="date" id="dto" onchange="setDF('custom',null)">
      <div class="spc"></div>
      <button class="expbtn" onclick="exportHistCsv()">üìä Excel</button>
    </div>
    <div class="twrap">
      <table>
        <thead><tr><th>Fecha</th><th>Subred</th><th>Placa</th><th>Tipo</th><th>Conductor</th><th>Auxiliar</th><th>M√©dico</th><th>Inicio</th><th>Cierre</th><th>Total</th><th>Resultado</th></tr></thead>
        <tbody id="htbody"></tbody>
      </table>
      <div class="empty" id="hempty">No hay turnos cerrados en este per√≠odo</div>
    </div>
  </div>

  <div class="footer">Sistema SCAT v2.0 ¬∑ <strong>Ing. Edisson Mac√≠as</strong> ¬∑ Secretar√≠a de Salud Bogot√° ¬∑ 2026</div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="mbox">
    <div class="m-title" id="m-title"></div>
    <div class="m-sub" id="m-sub"></div>
    <div class="m-warn org" id="m-dob" style="display:none"></div>
    <div class="m-warn prp" id="m-frz" style="display:none"></div>
    <div class="m-detail" id="m-detail"></div>
    <div class="m-btns">
      <button class="m-cancel" onclick="closeModal()">Cancelar</button>
      <button id="m-ok"></button>
    </div>
  </div>
</div>

<script>
const PIN       = '0816';
const LOCAL     = 'scat_v3';
const CLOSED    = 'scat_closed_v3';
const SHEET     = 'https://script.google.com/macros/s/AKfycbwvimLL3DM70rOD1_WvFwgBLeWiPKqaftODpR3U9XAU2aeY45uALX8QOpuTuMkF8QaB/exec';
const SH        = 12; // shift hours

let fSub = 'all', fSt = null, fQ = '', fDay = 'hoy';
let pending = null;
let active = [], closed = [];
let timer = null;

// ‚îÄ‚îÄ PIN ‚îÄ‚îÄ
function checkPin() {
  const code = ['p1','p2','p3','p4'].map(id => document.getElementById(id).value).join('');
  if (code === PIN) {
    document.getElementById('pin-scr').classList.add('off');
    document.getElementById('app').classList.add('on');
    loadData(); startTimer();
    if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
  } else {
    document.getElementById('pin-err').style.display = 'block';
    ['p1','p2','p3','p4'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('p1').focus();
    setTimeout(() => document.getElementById('pin-err').style.display = 'none', 3000);
  }
}
['p1','p2','p3','p4'].forEach((id, i, arr) => {
  const el = document.getElementById(id);
  el.addEventListener('input', () => {
    if (el.value.length === 1 && i < 3) document.getElementById(arr[i+1]).focus();
    if (i === 3 && el.value.length === 1) checkPin();
  });
  el.addEventListener('keydown', e => {
    if (e.key === 'Backspace' && !el.value && i > 0) document.getElementById(arr[i-1]).focus();
    if (e.key === 'Enter') checkPin();
  });
});
document.getElementById('p1').focus();

function logout() {
  clearInterval(timer);
  document.getElementById('app').classList.remove('on');
  document.getElementById('pin-scr').classList.remove('off');
  ['p1','p2','p3','p4'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('p1').focus();
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
setInterval(() => {
  document.getElementById('clk').textContent = new Date().toLocaleTimeString('es-CO',{hour12:false,hour:'2-digit',minute:'2-digit'});
}, 1000);

// ‚îÄ‚îÄ LOAD ‚îÄ‚îÄ
async function loadData(silent = false) {
  if (!silent) showLoad('Sincronizando...');
  try {
    const json = await new Promise((resolve, reject) => {
      const sc = document.createElement('script');
      const cb = '_cb_' + Date.now();
      window[cb] = d => { delete window[cb]; sc.remove(); resolve(d); };
      sc.onerror = () => reject();
      sc.src = SHEET + '?action=getAll&callback=' + cb;
      setTimeout(() => reject(), 8000);
      document.head.appendChild(sc);
    });
    if (json.status === 'ok') {
      const localClosed = JSON.parse(localStorage.getItem(CLOSED) || '[]');
      const closedIds   = new Set(localClosed.map(r => String(r.id)));
      active  = (json.active || []).filter(r => !closedIds.has(String(r.id)));
      const srv = json.closed || [];
      const srvIds = new Set(srv.map(r => String(r.id)));
      closed  = [...srv, ...localClosed.filter(r => !srvIds.has(String(r.id)))];
      localStorage.setItem(LOCAL,  JSON.stringify(active));
      localStorage.setItem(CLOSED, JSON.stringify(closed));
      document.getElementById('synctag').textContent = 'sync ' + new Date().toLocaleTimeString('es-CO',{hour12:false,hour:'2-digit',minute:'2-digit'});
    } else throw 0;
  } catch {
    active = JSON.parse(localStorage.getItem(LOCAL)  || '[]').filter(r => r.estado !== 'cerrado');
    closed = JSON.parse(localStorage.getItem(CLOSED) || '[]');
    document.getElementById('synctag').textContent = '‚ö† sin sync';
  }
  hideLoad(); renderAll(); checkAlerts();
}

async function closeRecord(id, action, rec) {
  const entry = { ...rec, cierre: new Date().toISOString(), accion: action, cerrado_por: 'Admin', estado: 'cerrado' };
  active = active.filter(r => String(r.id) !== String(id));
  closed.push(entry);
  localStorage.setItem(LOCAL,  JSON.stringify(active));
  localStorage.setItem(CLOSED, JSON.stringify(closed));
  renderAll();
  // Sync via JSONP
  try {
    await new Promise(res => {
      const cb = '_cl_' + Date.now();
      const sc = document.createElement('script');
      window[cb] = () => { delete window[cb]; sc.remove(); res(); };
      sc.onerror = () => { sc.remove(); res(); };
      const p = new URLSearchParams({ action:'close', id:String(id), entry:JSON.stringify(entry), callback:cb });
      sc.src = SHEET + '?' + p.toString();
      setTimeout(res, 8000);
      document.head.appendChild(sc);
    });
  } catch {}
}

function startTimer() { clearInterval(timer); timer = setInterval(() => loadData(true), 60000); }
function forceRefresh() { loadData(false); }

// ‚îÄ‚îÄ TIME ‚îÄ‚îÄ
const hrs  = iso => (Date.now() - new Date(iso)) / 3600000;
const isFrz = iso => hrs(iso) >= SH;

function fmtTime(iso) {
  const h = hrs(iso);
  if (h >= SH) return `‚ùÑ 12:00`;
  return `${Math.floor(h)}h ${Math.round((h%1)*60)}m`;
}
function fmtDate(iso) { if(!iso) return '‚Äî'; return new Date(iso).toLocaleString('es-CO',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); }
function fmtDateS(iso) { if(!iso) return '‚Äî'; return new Date(iso).toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function sc(s) { return s==='Norte'?'bn':s==='Sur'?'bs':s==='Sur Occidente'?'bso':s==='Centro Oriente'?'bco':''; }
function today() { return new Date().toISOString().slice(0,10); }

function getSt(iso) {
  const h = hrs(iso);
  if (h > 24)   return 'crit';
  if (h >= SH)  return 'frz';
  if (h >= 11)  return 'warn';
  return 'ok';
}

function getDob(rec) {
  const cutoff = Date.now() - 48*3600000;
  const prev   = closed.filter(r => new Date(r.cierre||r.inicio).getTime() >= cutoff);
  const pIds   = (ced) => prev.some(r => r.con_cedula===ced||r.aux_cedula===ced||r.med_cedula===ced);
  const people = [
    {ced:rec.con_cedula, nom:rec.con_nombre, rol:'Conductor'},
    {ced:rec.aux_cedula, nom:rec.aux_nombre, rol:'Auxiliar'},
    {ced:rec.med_cedula, nom:rec.med_nombre, rol:'M√©dico'},
  ].filter(p => p.ced && pIds(p.ced));
  return people;
}

// ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ
function checkAlerts() {
  const crits = active.filter(r => getSt(r.inicio) === 'crit');
  const dobs  = active.filter(r => getDob(r).length > 0);
  const frzs  = active.filter(r => getSt(r.inicio) === 'frz');

  const ba = (id, bt, bm, cls, t, m) => {
    const el = document.getElementById(id);
    if (m.length) { el.classList.add('show'); document.getElementById(bt).textContent = t; document.getElementById(bm).textContent = m.join(' ¬∑ '); }
    else el.classList.remove('show');
  };
  ba('ab-crit','ab-crit-t','ab-crit-m','red', `‚õî ${crits.length} m√≥vil(es) m√°s de 24h`, crits.map(r=>r.placa));
  ba('ab-dob', 'ab-dob-t', 'ab-dob-m', 'org', `‚ö†Ô∏è ${dobs.length} personal doblando`, dobs.map(r=>r.placa));
  ba('ab-frz', 'ab-frz-t', 'ab-frz-m', 'prp', `üü£ ${frzs.length} m√≥vil(es) esperando relevo (‚ùÑ 12:00)`, frzs.map(r=>r.placa));
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderAll() { renderKpi(); renderTable(); renderSubs(); renderHist(); }

function renderKpi() {
  const c = t => active.filter(r => getSt(r.inicio)===t).length;
  document.getElementById('kpis').innerHTML = `
    <div class="kpi k0"><div class="kn">${active.length}</div><div class="kl">Activas</div><div class="ks">Total</div></div>
    <div class="kpi k1"><div class="kn">${c('ok')}</div><div class="kl">Normal</div><div class="ks">&lt;11h</div></div>
    <div class="kpi k2"><div class="kn">${c('warn')}</div><div class="kl">Por Vencer</div><div class="ks">11‚Äì12h</div></div>
    <div class="kpi k3"><div class="kn">${c('frz')}</div><div class="kl">Relevo</div><div class="ks">‚ùÑ Congelado</div></div>
    <div class="kpi k4"><div class="kn">${active.filter(r=>getDob(r).length>0).length}</div><div class="kl">Doblados</div><div class="ks">2¬∞ turno</div></div>
    <div class="kpi k5"><div class="kn">${c('crit')}</div><div class="kl">Cr√≠tico</div><div class="ks">&gt;24h ‚ö†</div></div>`;
}

function renderTable() {
  let recs = [...active];
  if (fSub !== 'all') recs = recs.filter(r => r.subred === fSub);
  if (fSt) recs = recs.filter(r => {
    const st = getSt(r.inicio);
    if (fSt === 'frz')  return st === 'frz';
    if (fSt === 'warn') return st === 'warn';
    if (fSt === 'crit') return st === 'crit';
    if (fSt === 'dob')  return getDob(r).length > 0;
    return true;
  });
  if (fQ) recs = recs.filter(r => (r.placa||'').toUpperCase().includes(fQ.toUpperCase()) || (r.con_nombre||'').toLowerCase().includes(fQ.toLowerCase()));
  recs.sort((a,b) => hrs(b.inicio) - hrs(a.inicio));

  const empty = document.getElementById('empty');
  const tbody = document.getElementById('tbody');
  if (!recs.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = recs.map(r => {
    const st  = getSt(r.inicio);
    const dob = getDob(r);
    const rowC = st==='crit'?'rc':st==='frz'?'rf':st==='warn'?'rw':'';

    const tLabel = st==='frz'
      ? `<span class="htag frz">‚ùÑ 12:00 ‚Äî Relevo</span>`
      : `<span class="htag ${st}">${fmtTime(r.inicio)}</span>`;

    const stLabel = st==='crit'?'üî¥ CR√çTICO':st==='frz'?'üü£ RELEVO':st==='warn'?'üü° Por vencer':'‚úÖ Normal';

    const personHTML = dob.length
      ? dob.map(p => `<span class="dbadge d1">üü† ${p.rol}</span>`).join('<br>')
      : '<span style="font-size:.68rem;color:var(--grn)">‚úÖ</span>';

    const pCell = (nom, ced, foto) => {
      if (!nom) return `<span class="na">N/A</span>`;
      return `<div class="pblock">
        <span class="pname">${nom}</span>
        <span class="pdoc">${ced||'‚Äî'}</span>
        ${foto ? `<a href="${foto}" target="_blank" class="pfoto">üì∑ Ver foto</a>` : ''}
      </div>`;
    };

    let btn;
    if (st === 'crit') btn = `<button class="abtn stop" onclick="openModal('${r.id}','detener')">üõë Detener</button>`;
    else if (st === 'frz') btn = `<button class="abtn relay" onclick="openModal('${r.id}','relevo')">üü£ Sin relevo</button>`;
    else btn = `<button class="abtn close" onclick="openModal('${r.id}','cerrar')">‚úì Cerrar</button>`;

    return `<tr class="${rowC}">
      <td><span class="bsub ${sc(r.subred)}">${r.subred}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.8rem">${r.placa}</td>
      <td><span class="btp">${r.tipo}</span></td>
      <td>${pCell(r.med_nombre, r.med_cedula, r.med_foto_url)}</td>
      <td>${pCell(r.con_nombre, r.con_cedula, r.con_foto_url)}</td>
      <td>${pCell(r.aux_nombre, r.aux_cedula, r.aux_foto_url)}</td>
      <td style="font-size:.7rem;color:var(--sub)">${r.turno}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.67rem;color:var(--sub)">${fmtDate(r.inicio)}</td>
      <td>${tLabel}</td>
      <td><span class="stchip ${st}">${stLabel}</span></td>
      <td>${personHTML}</td>
      <td>${btn}</td>
    </tr>`;
  }).join('');
}

function renderSubs() {
  const subredes = [{n:'Norte',c:'#60A5FA'},{n:'Sur',c:'#4ADE80'},{n:'Sur Occidente',c:'#FCD34D'},{n:'Centro Oriente',c:'#C084FC'}];
  document.getElementById('sgrid').innerHTML = subredes.map(s => {
    const rows = active.filter(r => r.subred === s.n).sort((a,b) => hrs(b.inicio)-hrs(a.inicio));
    const cnt = {ok:0,warn:0,frz:0,crit:0};
    rows.forEach(r => { const st=getSt(r.inicio); cnt[st]=(cnt[st]||0)+1; });

    const rowsH = rows.length ? rows.map(r => {
      const st  = getSt(r.inicio);
      const dob = getDob(r);
      const tStr = st==='frz' ? '‚ùÑ 12:00' : fmtTime(r.inicio);
      return `<div class="srow ${st==='crit'?'rc':st==='frz'?'rf':st==='warn'?'rw':''}">
        <div class="srow-top">
          <span class="srow-placa">${r.placa}</span>
          <span class="btp">${r.tipo}</span>
          <span class="htag ${st}" style="margin-left:auto">${tStr}</span>
        </div>
        <div class="srow-people">
          ${r.med_nombre ? `<div class="sp-row"><span class="sp-role med">M√©dico</span><span class="sp-name">${r.med_nombre}</span><span class="sp-doc">${r.med_cedula||''}</span></div>` : ''}
          <div class="sp-row"><span class="sp-role con">Conductor</span><span class="sp-name">${r.con_nombre||'‚Äî'}</span><span class="sp-doc">${r.con_cedula||''}</span>${dob.find(d=>d.ced===r.con_cedula)?`<span class="dbadge d1">DOBLADO</span>`:''}</div>
          <div class="sp-row"><span class="sp-role aux">Auxiliar</span><span class="sp-name">${r.aux_nombre||'‚Äî'}</span><span class="sp-doc">${r.aux_cedula||''}</span></div>
        </div>
      </div>`;
    }).join('') : `<div style="text-align:center;padding:1.5rem;color:var(--mut);font-size:.78rem">Sin m√≥viles activas</div>`;

    return `<div class="spanel">
      <div class="spanel-hd">
        <div class="spanel-dot" style="background:${s.c}"></div>
        <div class="spanel-name" style="color:${s.c}">Subred ${s.n}</div>
        <div class="spanel-counts">
          ${cnt.ok?`<span class="mc ok">${cnt.ok}</span>`:''}
          ${cnt.warn?`<span class="mc warn">${cnt.warn}</span>`:''}
          ${cnt.frz?`<span class="mc frz">${cnt.frz} ‚ùÑ</span>`:''}
          ${cnt.crit?`<span class="mc crit">${cnt.crit}</span>`:''}
        </div>
      </div>
      <div class="spanel-body">${rowsH}</div>
    </div>`;
  }).join('');
}

function renderHist() {
  const now = new Date();
  const s0 = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
  const e0 = d => { const x=new Date(d); x.setHours(23,59,59,999); return x; };
  let recs = [...closed];
  if (fDay==='hoy') recs = recs.filter(r => new Date(r.cierre||r.inicio) >= s0(now) && new Date(r.cierre||r.inicio) <= e0(now));
  else if (fDay==='ayer') { const y=new Date(now); y.setDate(y.getDate()-1); recs=recs.filter(r=>new Date(r.cierre||r.inicio)>=s0(y)&&new Date(r.cierre||r.inicio)<=e0(y)); }
  else if (fDay==='sem') { const s=new Date(now); s.setDate(s.getDate()-7); recs=recs.filter(r=>new Date(r.cierre||r.inicio)>=s); }
  else if (fDay==='custom') {
    const from=document.getElementById('dfrom').value, to=document.getElementById('dto').value;
    if(from) recs=recs.filter(r=>new Date(r.cierre||r.inicio)>=new Date(from));
    if(to)   recs=recs.filter(r=>new Date(r.cierre||r.inicio)<=e0(new Date(to)));
  }

  const tbody=document.getElementById('htbody'), empty=document.getElementById('hempty');
  if (!recs.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';

  tbody.innerHTML = [...recs].reverse().map(r => {
    const tot = r.cierre ? ((new Date(r.cierre)-new Date(r.inicio))/3600000) : 0;
    const st  = tot>24?'crit':tot>12?'dob':tot>=11?'warn':'ok';
    return `<tr class="closed-r">
      <td style="font-size:.68rem">${fmtDateS(r.cierre||r.inicio)}</td>
      <td><span class="bsub ${sc(r.subred)}">${r.subred}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.76rem;font-weight:600">${r.placa}</td>
      <td><span class="btp">${r.tipo}</span></td>
      <td style="font-size:.74rem">${r.con_nombre||'‚Äî'}</td>
      <td style="font-size:.74rem">${r.aux_nombre||'‚Äî'}</td>
      <td style="font-size:.74rem">${r.med_nombre||'N/A'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.68rem">${fmtDate(r.inicio)}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.68rem">${fmtDate(r.cierre)}</td>
      <td><span class="htag ${st}">${Math.floor(tot)}h ${Math.round((tot%1)*60)}m</span></td>
      <td style="font-size:.71rem;font-weight:700;color:${r.accion==='detener'?'var(--red)':r.accion==='relevo'?'var(--prp)':'var(--grn)'}">${r.accion==='detener'?'üõë DETENIDA':r.accion==='relevo'?'üü£ SIN RELEVO':'‚úì Normal'}</td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
function setF(val, btn) { fSub=val; fSt=null; fQ=''; document.querySelectorAll('#tbar .chip').forEach(b=>b.classList.remove('on')); btn.classList.add('on'); document.getElementById('srch').value=''; renderTable(); }
function setSF(type, btn) { fSt=fSt===type?null:type; fSub='all'; document.querySelectorAll('#tbar .chip').forEach(b=>b.classList.remove('on')); if(fSt)btn.classList.add('on'); else document.querySelector('#tbar .chip').classList.add('on'); renderTable(); }
function setSearch(q) { fQ=q; renderTable(); }
function showTab(name, btn) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('on')); document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on')); document.getElementById('tab-'+name).classList.add('on'); btn.classList.add('on'); }
function setDF(type, btn) { fDay=type; document.querySelectorAll('.hbar .chip').forEach(b=>b.classList.remove('on')); if(btn)btn.classList.add('on'); renderHist(); }

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(id, action) {
  const r = active.find(x => String(x.id) === String(id));
  if (!r) return;
  pending = {id, action, rec: r};
  const h   = hrs(r.inicio);
  const st  = getSt(r.inicio);
  const dob = getDob(r);

  document.getElementById('m-title').textContent = action==='detener'?'üõë Detener M√≥vil':action==='relevo'?'üü£ Cerrar ‚Äî Sin Relevo':'‚úì Cerrar Turno';
  document.getElementById('m-sub').textContent   = action==='detener'?'Esta m√≥vil lleva m√°s de 24h activa.':action==='relevo'?'Turno de 12h terminado sin relevo. El personal sale del listado.':'Confirme el cierre del turno.';

  const dw = document.getElementById('m-dob');
  dw.style.display = dob.length ? 'block' : 'none';
  if (dob.length) dw.innerHTML = '‚ö†Ô∏è <strong>Doblando:</strong> '+dob.map(p=>p.rol+': '+p.nom).join(', ');

  const fw = document.getElementById('m-frz');
  fw.style.display = st==='frz' ? 'block' : 'none';
  if (st==='frz') fw.innerHTML = 'üü£ Turno congelado en 12:00 ‚Äî sin relevo registrado.';

  document.getElementById('m-detail').innerHTML =
    `<strong>${r.placa} ¬∑ ${r.tipo} ¬∑ Subred ${r.subred}</strong>
    Conductor: ${r.con_nombre} (CC ${r.con_cedula})<br>
    Auxiliar: ${r.aux_nombre} (CC ${r.aux_cedula})<br>
    ${r.med_nombre ? 'M√©dico: '+r.med_nombre+'<br>' : ''}
    Inicio: ${fmtDate(r.inicio)}`;

  const btn = document.getElementById('m-ok');
  btn.textContent = action==='detener'?'üõë Detener':action==='relevo'?'üü£ Sin Relevo':'‚úì Confirmar Cierre';
  btn.className   = 'm-ok' + (action==='detener'?' red':'');
  btn.onclick     = confirmModal;
  document.getElementById('modal').classList.add('open');
}

async function confirmModal() {
  if (!pending) return;
  const btn = document.getElementById('m-ok');
  btn.innerHTML = '<span class="spin"></span>Guardando...';
  btn.disabled  = true;
  await closeRecord(pending.id, pending.action, pending.rec);
  btn.disabled  = false;
  closeModal();
}
function closeModal() { document.getElementById('modal').classList.remove('open'); pending = null; }

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportCsv() {
  const h = ['Subred','Placa','Tipo','Turno','Inicio','Tiempo','Estado','M√©dico','Ced.Med','Conductor','Ced.Con','Auxiliar','Ced.Aux'];
  const rows = [...active].sort((a,b)=>hrs(b.inicio)-hrs(a.inicio)).map(r => {
    const st = getSt(r.inicio);
    return [r.subred,r.placa,r.tipo,r.turno,fmtDate(r.inicio),fmtTime(r.inicio),st==='crit'?'CRITICO':st==='frz'?'RELEVO':st==='warn'?'POR VENCER':'Normal',r.med_nombre||'N/A',r.med_cedula||'',r.con_nombre,r.con_cedula,r.aux_nombre,r.aux_cedula];
  });
  dlCsv([h,...rows], 'SCAT_Activas_'+today());
}
function exportHistCsv() {
  const h = ['Fecha','Subred','Placa','Tipo','Inicio','Cierre','Total','Conductor','Auxiliar','M√©dico','Resultado'];
  const rows = [...closed].reverse().map(r => {
    const tot = r.cierre?((new Date(r.cierre)-new Date(r.inicio))/3600000):0;
    return [fmtDateS(r.cierre||r.inicio),r.subred,r.placa,r.tipo,fmtDate(r.inicio),fmtDate(r.cierre),`${Math.floor(tot)}h ${Math.round((tot%1)*60)}m`,r.con_nombre,r.aux_nombre,r.med_nombre||'N/A',r.accion==='detener'?'DETENIDA':r.accion==='relevo'?'SIN RELEVO':'Normal'];
  });
  dlCsv([h,...rows], 'SCAT_Historial_'+today());
}
function dlCsv(rows, name) {
  const csv = rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a   = document.createElement('a');
  a.href    = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));
  a.download= name+'.csv'; a.click();
}
function exportTxt() {
  let txt = `REPORTE SCAT ‚Äî ${new Date().toLocaleString('es-CO')}\n${'‚ïê'.repeat(55)}\nIng. Edisson Mac√≠as ¬∑ Secretar√≠a de Salud Bogot√°\n\n`;
  ['Norte','Sur','Sur Occidente','Centro Oriente'].forEach(s => {
    const recs = [...active].filter(r=>r.subred===s).sort((a,b)=>hrs(b.inicio)-hrs(a.inicio));
    txt += `SUBRED ${s.toUpperCase()} (${recs.length})\n${'‚îÄ'.repeat(38)}\n`;
    recs.forEach(r => {
      const st=getSt(r.inicio);
      const ico=st==='crit'?'üî¥':st==='frz'?'üü£':st==='warn'?'üü°':'‚úÖ';
      txt += `\n  ${ico} ${r.placa} (${r.tipo}) ¬∑ ${fmtTime(r.inicio)}\n`;
      if (r.med_nombre) txt += `  M√©dico:    ${r.med_nombre} ¬∑ CC ${r.med_cedula}\n`;
      txt += `  Conductor: ${r.con_nombre} ¬∑ CC ${r.con_cedula}\n`;
      txt += `  Auxiliar:  ${r.aux_nombre} ¬∑ CC ${r.aux_cedula}\n`;
    });
    txt += '\n';
  });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([txt],{type:'text/plain;charset=utf-8'}));
  a.download=`Reporte_${today()}.txt`; a.click();
}

function showLoad(t) { document.getElementById('ltxt').textContent=t||''; document.getElementById('lov').classList.add('show'); }
function hideLoad() { document.getElementById('lov').classList.remove('show'); }
</script>
</body>
</html>
