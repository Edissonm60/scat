<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ¬∑ SCAT Control</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#060B18; --bg2:#0C1426; --surface:#0F1D35; --surface2:#162440;
  --border:#1E3050; --border2:#243B5E;
  --accent:#3B82F6; --accent-glow:rgba(59,130,246,0.25);
  --green:#22C55E; --green-dim:rgba(34,197,94,0.12);
  --yellow:#F59E0B; --yellow-dim:rgba(245,158,11,0.12);
  --orange:#F97316; --orange-dim:rgba(249,115,22,0.12);
  --red:#EF4444; --red-dim:rgba(239,68,68,0.12);
  --text:#F1F5F9; --text-sub:#94A3B8; --text-muted:#4A6080;
  --norte:#60A5FA; --sur:#4ADE80; --suroc:#FCD34D; --co:#C084FC;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* PIN */
.pin-screen{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;}
.pin-screen.hidden{display:none;}
.pin-logo{font-size:3rem;margin-bottom:1rem;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pin-title{font-size:1.5rem;font-weight:800;text-align:center;margin-bottom:6px;}
.pin-sub{font-size:0.82rem;color:var(--text-sub);text-align:center;margin-bottom:2rem;max-width:300px;line-height:1.5;}
.pin-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:2rem;width:100%;max-width:360px;box-shadow:0 24px 80px rgba(0,0,0,0.5);}
.url-section{margin-bottom:1.2rem;}
.url-label{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-sub);margin-bottom:6px;display:block;}
.url-input-wrap{display:flex;gap:6px;}
.config-input{flex:1;padding:9px 11px;background:var(--bg2);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.7rem;}
.config-input:focus{outline:none;border-color:var(--accent);}
.btn-save-url{padding:9px 14px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:0.75rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Outfit',sans-serif;}
.url-status{font-size:0.68rem;margin-top:5px;min-height:16px;font-weight:600;}
.url-status.ok{color:var(--green);}
.url-status.err{color:var(--red);}
.pin-divider{border:none;border-top:1px solid var(--border);margin:1.2rem 0;}
.pin-label{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-sub);margin-bottom:10px;text-align:center;}
.pin-input-wrap{display:flex;gap:10px;justify-content:center;margin-bottom:1.2rem;}
.pin-digit{width:52px;height:60px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--text);transition:all 0.2s;-webkit-appearance:none;caret-color:var(--accent);}
.pin-digit:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow);background:var(--surface);}
.btn-pin{width:100%;padding:14px;background:var(--accent);border:none;border-radius:12px;color:#fff;font-family:'Outfit',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;}
.pin-error{text-align:center;margin-top:10px;font-size:0.8rem;color:var(--red);font-weight:600;display:none;}
.pin-hint{text-align:center;margin-top:12px;font-size:0.7rem;color:var(--text-muted);}
.pin-hint strong{color:var(--text-sub);}

/* APP */
.app{display:none;}
.app.visible{display:block;}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:rgba(6,11,24,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);height:58px;display:flex;align-items:center;padding:0 1.5rem;gap:1rem;}
.topbar-logo{font-size:0.95rem;font-weight:800;color:var(--text);display:flex;align-items:center;gap:8px;}
.logo-badge{background:var(--accent);color:#fff;font-size:0.6rem;font-weight:700;padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:0.06em;}
.topbar-tabs{display:flex;gap:4px;margin-left:1rem;}
.tab-btn{padding:6px 14px;border-radius:8px;border:none;background:none;color:var(--text-sub);font-family:'Outfit',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.tab-btn:hover{background:var(--surface2);color:var(--text);}
.tab-btn.active{background:var(--surface2);color:var(--accent);border:1px solid var(--border2);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.clock-display{font-family:'JetBrains Mono',monospace;font-size:0.82rem;color:var(--text-sub);background:var(--surface);border:1px solid var(--border);padding:4px 10px;border-radius:6px;}
.btn-refresh{padding:5px 12px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--text-muted);font-size:0.75rem;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;}
.btn-refresh:hover{border-color:var(--accent);color:var(--accent);}
.btn-logout{padding:5px 12px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--text-muted);font-size:0.75rem;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;}
.btn-logout:hover{border-color:var(--red);color:var(--red);}
.sync-tag{font-size:0.68rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace;}

/* VIEWS */
.view{display:none;padding:1.5rem;}
.view.active{display:block;}

/* ALERT BANNERS */
.alert-banner{display:none;border-radius:12px;padding:14px 18px;margin-bottom:1rem;}
.alert-banner.show{display:flex;align-items:center;gap:12px;}
.alert-banner.crit{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.4);}
.alert-banner.doblado{background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.4);}
.alert-banner-text{flex:1;font-size:0.82rem;line-height:1.5;}
.alert-banner-text strong{display:block;font-size:0.9rem;margin-bottom:2px;}
.alert-banner.crit .alert-banner-text strong{color:var(--red);}
.alert-banner.doblado .alert-banner-text strong{color:var(--orange);}
.btn-notify{padding:7px 14px;background:var(--red);border:none;border-radius:8px;color:#fff;font-size:0.75rem;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap;}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;margin-bottom:1.5rem;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.1rem 1.2rem;position:relative;overflow:hidden;}
.kpi-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;}
.kpi-card.k-total::after{background:var(--accent);}
.kpi-card.k-ok::after{background:var(--green);}
.kpi-card.k-warn::after{background:var(--yellow);}
.kpi-card.k-dob::after{background:var(--orange);animation:pulse-bar 2s infinite;}
.kpi-card.k-crit::after{background:var(--red);animation:pulse-bar 2s infinite;}
@keyframes pulse-bar{0%,100%{opacity:1}50%{opacity:0.4}}
.kpi-num{font-family:'JetBrains Mono',monospace;font-size:2.2rem;font-weight:600;line-height:1;}
.kpi-card.k-total .kpi-num{color:var(--accent);}
.kpi-card.k-ok .kpi-num{color:var(--green);}
.kpi-card.k-warn .kpi-num{color:var(--yellow);}
.kpi-card.k-dob .kpi-num{color:var(--orange);}
.kpi-card.k-crit .kpi-num{color:var(--red);}
.kpi-label{font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-top:6px;}
.kpi-sub{font-size:0.65rem;color:var(--text-muted);margin-top:2px;}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:1rem;flex-wrap:wrap;}
.filter-chip{padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:none;color:var(--text-muted);font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:'Outfit',sans-serif;}
.filter-chip:hover{border-color:var(--accent);color:var(--accent);}
.filter-chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.filter-chip.norte.active{background:var(--norte);border-color:var(--norte);color:#000;}
.filter-chip.sur.active{background:var(--sur);border-color:var(--sur);color:#000;}
.filter-chip.suroc.active{background:var(--suroc);border-color:var(--suroc);color:#000;}
.filter-chip.co.active{background:var(--co);border-color:var(--co);color:#000;}
.filter-chip.warn-f.active{background:var(--yellow);border-color:var(--yellow);color:#000;}
.filter-chip.dob-f.active{background:var(--orange);border-color:var(--orange);color:#000;}
.filter-chip.crit-f.active{background:var(--red);border-color:var(--red);color:#fff;}
.search-box{padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Outfit',sans-serif;font-size:0.8rem;width:150px;}
.search-box:focus{outline:none;border-color:var(--accent);}
.spacer{flex:1;}
.btn-export{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text-sub);font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:'Outfit',sans-serif;}
.btn-export:hover{border-color:var(--accent);color:var(--accent);}

/* TABLE */
.table-wrap{overflow-x:auto;border-radius:14px;border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;font-size:0.8rem;}
thead th{background:var(--surface2);padding:10px 12px;text-align:left;font-size:0.63rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);white-space:nowrap;border-bottom:1px solid var(--border);}
tbody tr{border-bottom:1px solid rgba(30,48,80,0.5);transition:background 0.15s;}
tbody tr:hover{background:rgba(255,255,255,0.02);}
tbody tr.r-crit{background:rgba(239,68,68,0.05);}
tbody tr.r-crit td:first-child{border-left:3px solid var(--red);}
tbody tr.r-dob{background:rgba(249,115,22,0.05);}
tbody tr.r-dob td:first-child{border-left:3px solid var(--orange);}
tbody tr.r-warn{background:rgba(245,158,11,0.05);}
tbody tr.r-warn td:first-child{border-left:3px solid var(--yellow);}
td{padding:10px 12px;vertical-align:middle;}

/* BADGES */
.b-subred{padding:3px 10px;border-radius:20px;font-size:0.67rem;font-weight:700;display:inline-block;white-space:nowrap;}
.b-subred.norte{background:rgba(96,165,250,0.12);color:var(--norte);border:1px solid rgba(96,165,250,0.25);}
.b-subred.sur{background:rgba(74,222,128,0.12);color:var(--sur);border:1px solid rgba(74,222,128,0.25);}
.b-subred.suroc{background:rgba(252,211,77,0.12);color:var(--suroc);border:1px solid rgba(252,211,77,0.25);}
.b-subred.co{background:rgba(192,132,252,0.12);color:var(--co);border:1px solid rgba(192,132,252,0.25);}
.b-tipo{padding:2px 8px;border-radius:4px;font-size:0.63rem;font-weight:700;background:var(--surface2);color:var(--text-muted);border:1px solid var(--border);white-space:nowrap;}
.hours-tag{font-family:'JetBrains Mono',monospace;font-size:0.78rem;font-weight:600;padding:3px 10px;border-radius:6px;display:inline-block;white-space:nowrap;}
.hours-tag.ok{background:var(--green-dim);color:var(--green);}
.hours-tag.warn{background:var(--yellow-dim);color:var(--yellow);}
.hours-tag.dob{background:var(--orange-dim);color:var(--orange);}
.hours-tag.crit{background:var(--red-dim);color:var(--red);animation:glow-red 2s infinite;}
@keyframes glow-red{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}50%{box-shadow:0 0 8px rgba(239,68,68,0.4)}}
.status-chip{font-size:0.68rem;font-weight:700;padding:4px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;}
.status-chip.ok{background:var(--green-dim);color:var(--green);}
.status-chip.warn{background:var(--yellow-dim);color:var(--yellow);}
.status-chip.dob{background:var(--orange-dim);color:var(--orange);}
.status-chip.crit{background:var(--red-dim);color:var(--red);}

/* DOBLADO BADGE */
.b-doblado{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:4px;font-size:0.6rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em;margin-left:4px;white-space:nowrap;}
.b-doblado.d1{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(249,115,22,0.3);}
.b-doblado.d2{background:var(--red-dim);color:var(--red);border:1px solid rgba(239,68,68,0.3);animation:glow-red 2s infinite;}

.person-block{display:flex;flex-direction:column;gap:2px;}
.person-name{font-weight:500;font-size:0.8rem;color:var(--text);white-space:nowrap;}
.person-doc{font-family:'JetBrains Mono',monospace;font-size:0.63rem;color:var(--text-muted);}
.na-tag{color:var(--text-muted);font-size:0.72rem;}
.btn-action{padding:4px 10px;border-radius:6px;border:none;font-size:0.7rem;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;white-space:nowrap;}
.btn-cerrar{background:var(--surface2);color:var(--text-sub);border:1px solid var(--border);}
.btn-cerrar:hover{border-color:var(--green);color:var(--green);}
.btn-detener{background:var(--red-dim);color:var(--red);border:1px solid rgba(239,68,68,0.3);}
.btn-detener:hover{background:rgba(239,68,68,0.2);}

/* HISTORIAL */
.date-filter-bar{display:flex;align-items:center;gap:10px;margin-bottom:1rem;flex-wrap:wrap;}
.date-input{padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Outfit',sans-serif;font-size:0.8rem;}
.date-input:focus{outline:none;border-color:var(--accent);}
.day-chip{padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:none;color:var(--text-muted);font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:'Outfit',sans-serif;}
.day-chip:hover{border-color:var(--accent);color:var(--accent);}
.day-chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}

/* SUBRED GRID */
.subred-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;}
.subred-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
.subred-panel-head{padding:14px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.subred-panel-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.subred-panel-name{font-size:0.9rem;font-weight:700;}
.subred-panel-count{margin-left:auto;display:flex;gap:6px;}
.mini-count{font-size:0.63rem;font-weight:700;padding:2px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;}
.mini-count.ok{background:var(--green-dim);color:var(--green);}
.mini-count.warn{background:var(--yellow-dim);color:var(--yellow);}
.mini-count.dob{background:var(--orange-dim);color:var(--orange);}
.mini-count.crit{background:var(--red-dim);color:var(--red);}
.subred-panel-body{padding:12px;}
.subred-row{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:8px;}
.subred-row:last-child{margin-bottom:0;}
.subred-row.r-crit{border-color:rgba(239,68,68,0.35);background:rgba(239,68,68,0.04);}
.subred-row.r-dob{border-color:rgba(249,115,22,0.35);background:rgba(249,115,22,0.04);}
.subred-row.r-warn{border-color:rgba(245,158,11,0.35);background:rgba(245,158,11,0.04);}
.subred-row-top{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;}
.subred-row-placa{font-family:'JetBrains Mono',monospace;font-size:0.85rem;font-weight:600;}
.subred-row-people{display:flex;flex-direction:column;gap:3px;font-size:0.74rem;}
.subred-row-person{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.srp-role{font-weight:700;min-width:60px;}
.srp-role.med{color:var(--norte);}
.srp-role.con{color:var(--sur);}
.srp-role.aux{color:var(--co);}
.srp-name{color:var(--text-sub);}
.srp-doc{font-family:'JetBrains Mono',monospace;font-size:0.63rem;color:var(--text-muted);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:2rem;width:100%;max-width:420px;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:slideUp 0.3s ease;}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-size:1.1rem;font-weight:800;margin-bottom:8px;}
.modal-detail{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin:1rem 0;font-size:0.82rem;color:var(--text-sub);line-height:1.7;}
.modal-detail strong{color:var(--text);display:block;margin-bottom:4px;}
.modal-doblado-warn{background:var(--orange-dim);border:1px solid rgba(249,115,22,0.3);border-radius:8px;padding:10px 12px;margin-bottom:10px;font-size:0.78rem;color:var(--orange);line-height:1.5;}
.modal-buttons{display:flex;gap:10px;margin-top:1.2rem;}
.btn-modal-cancel{flex:1;padding:12px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--text-sub);cursor:pointer;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.85rem;}
.btn-modal-confirm{flex:2;padding:12px;background:var(--green);border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;font-size:0.85rem;}
.btn-modal-detener{flex:2;padding:12px;background:var(--red);border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;font-size:0.85rem;}

/* LOADING */
.loading-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(6,11,24,0.7);backdrop-filter:blur(4px);align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.loading-overlay.show{display:flex;}
.loading-ring{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:0.85rem;color:var(--text-sub);}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;margin-right:6px;}

.empty{text-align:center;padding:3rem;color:var(--text-muted);font-size:0.85rem;}
.closed-row{opacity:0.6;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
@media(max-width:900px){.kpi-row{grid-template-columns:1fr 1fr 1fr;}.subred-grid{grid-template-columns:1fr;}}
@media(max-width:600px){.kpi-row{grid-template-columns:1fr 1fr;}.view{padding:1rem;}.topbar{padding:0 1rem;gap:6px;}}
</style>
</head>
<body>

<!-- PIN -->
<div class="pin-screen" id="pin-screen">
  <div class="pin-logo">üöë</div>
  <div class="pin-title">Panel de Control</div>
  <div class="pin-sub">Secretar√≠a de Salud Bogot√°<br>Acceso restringido</div>
  <div class="pin-box">
    <div class="url-section">
      <span class="url-label">üîó URL de Google Apps Script</span>
      <div class="url-input-wrap">
        <input class="config-input" type="text" id="sheet-url-input" placeholder="https://script.google.com/macros/s/...">
        <button class="btn-save-url" onclick="saveUrlManual()">Guardar</button>
      </div>
      <div class="url-status" id="url-status"></div>
    </div>
    <hr class="pin-divider">
    <div class="pin-label">Ingrese su clave de acceso</div>
    <div class="pin-input-wrap">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p1">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p2">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p3">
      <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" id="p4">
    </div>
    <button class="btn-pin" onclick="checkPin()">INGRESAR</button>
    <div class="pin-error" id="pin-error">Clave incorrecta.</div>
    <div class="pin-hint">Clave predeterminada: <strong>1234</strong></div>
  </div>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-ring"></div>
  <div class="loading-text" id="loading-text">Cargando...</div>
</div>

<!-- APP -->
<div class="app" id="app">
  <header class="topbar">
    <div class="topbar-logo">üöë SCAT <span class="logo-badge">Admin</span></div>
    <nav class="topbar-tabs">
      <button class="tab-btn active" onclick="showTab('dashboard',this)">üìä Dashboard</button>
      <button class="tab-btn" onclick="showTab('subredes',this)">üìç Por Subred</button>
      <button class="tab-btn" onclick="showTab('historial',this)">üìã Historial</button>
    </nav>
    <div class="topbar-right">
      <div class="live-dot"></div>
      <span class="sync-tag" id="sync-tag">--</span>
      <div class="clock-display" id="clock">--:--:--</div>
      <button class="btn-refresh" onclick="forceRefresh()">‚ü≥ Actualizar</button>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </div>
  </header>

  <!-- DASHBOARD -->
  <div class="view active" id="tab-dashboard">
    <div class="alert-banner crit" id="alert-crit">
      <div>‚õî</div>
      <div class="alert-banner-text">
        <strong id="alert-crit-title">Alerta Cr√≠tica</strong>
        <span id="alert-crit-msg"></span>
      </div>
      <button class="btn-notify" onclick="sendNotification('crit')">üîî Notificar</button>
    </div>
    <div class="alert-banner doblado" id="alert-dob">
      <div>‚ö†Ô∏è</div>
      <div class="alert-banner-text">
        <strong id="alert-dob-title">Personal Doblado</strong>
        <span id="alert-dob-msg"></span>
      </div>
      <button class="btn-notify" style="background:var(--orange)" onclick="sendNotification('dob')">üîî Notificar</button>
    </div>
    <div class="kpi-row" id="kpi-row"></div>
    <div class="toolbar" id="toolbar">
      <button class="filter-chip active" onclick="setFilter('all',this)">Todas</button>
      <button class="filter-chip norte" onclick="setFilter('Norte',this)">Norte</button>
      <button class="filter-chip sur" onclick="setFilter('Sur',this)">Sur</button>
      <button class="filter-chip suroc" onclick="setFilter('Sur Occidente',this)">Sur Occidente</button>
      <button class="filter-chip co" onclick="setFilter('Centro Oriente',this)">Centro Oriente</button>
      <button class="filter-chip warn-f" onclick="setStatusFilter('warn',this)">üü° Por vencer</button>
      <button class="filter-chip dob-f" onclick="setStatusFilter('dob',this)">üü† Doblados</button>
      <button class="filter-chip crit-f" onclick="setStatusFilter('crit',this)">üî¥ Cr√≠ticos</button>
      <input class="search-box" type="text" placeholder="üîç Buscar placa..." oninput="searchFilter(this.value)" id="search-box">
      <div class="spacer"></div>
      <button class="btn-export" onclick="exportExcel()">üìä Excel</button>
      <button class="btn-export" onclick="exportTxt()">‚¨á Texto</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Subred</th><th>M√≥vil</th><th>Tipo</th>
            <th>M√©dico</th><th>Conductor</th><th>Auxiliar</th>
            <th>Turno</th><th>Inicio</th><th>Tiempo</th>
            <th>Estado turno</th><th>Personal</th><th>Referente</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="main-tbody"></tbody>
      </table>
      <div class="empty" id="main-empty" style="display:none">
        <div style="font-size:2.5rem;margin-bottom:8px">üöë</div>
        No hay m√≥viles activas con los filtros actuales
      </div>
    </div>
  </div>

  <!-- SUBREDES -->
  <div class="view" id="tab-subredes">
    <div class="subred-grid" id="subred-grid"></div>
  </div>

  <!-- HISTORIAL -->
  <div class="view" id="tab-historial">
    <div class="date-filter-bar">
      <div style="font-size:1rem;font-weight:700;margin-right:4px">Historial de Turnos</div>
      <button class="day-chip active" onclick="setDayFilter('today',this)">Hoy</button>
      <button class="day-chip" onclick="setDayFilter('yesterday',this)">Ayer</button>
      <button class="day-chip" onclick="setDayFilter('week',this)">Esta semana</button>
      <button class="day-chip" onclick="setDayFilter('all',this)">Todo</button>
      <input class="date-input" type="date" id="date-from" onchange="setDayFilter('custom',null)">
      <input class="date-input" type="date" id="date-to" onchange="setDayFilter('custom',null)">
      <div class="spacer"></div>
      <button class="btn-export" onclick="exportHistorialExcel()">üìä Excel</button>
      <button class="btn-export" onclick="clearClosed()" style="border-color:var(--red);color:var(--red)">üóë Limpiar</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Subred</th><th>M√≥vil</th><th>Tipo</th>
            <th>Conductor</th><th>Auxiliar</th><th>M√©dico</th>
            <th>Inicio</th><th>Cierre</th><th>Total horas</th><th>Resultado</th>
          </tr>
        </thead>
        <tbody id="hist-tbody"></tbody>
      </table>
      <div class="empty" id="hist-empty">No hay turnos cerrados en el per√≠odo seleccionado</div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modal-title"></div>
    <div style="font-size:0.82rem;color:var(--text-sub)" id="modal-sub"></div>
    <div class="modal-doblado-warn" id="modal-dob-warn" style="display:none"></div>
    <div class="modal-detail" id="modal-detail"></div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal()">Cancelar</button>
      <button id="modal-confirm-btn"></button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PIN           = '1234';
const LOCAL_KEY     = 'scat_registros_v3';
const CLOSED_KEY    = 'scat_cerrados_v3';
const SHEET_URL_KEY = 'scat_sheet_url';
const SHIFT_HOURS   = 12; // duraci√≥n normal de un turno

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeFilter  = 'all';
let statusFilter  = null;
let searchQuery   = '';
let dayFilter     = 'today';
let pendingAction = null;
let activeData    = [];
let closedData    = [];
let autoRefreshTimer = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// URL MANAGEMENT ‚Äî guarda siempre antes de cualquier acci√≥n
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getSheetUrl() { return localStorage.getItem(SHEET_URL_KEY) || 'https://script.google.com/macros/s/AKfycbwvimLL3DM70rOD1_WvFwgBLeWiPKqaftODpR3U9XAU2aeY45uALX8QOpuTuMkF8QaB/exec'; }

function saveUrlManual() {
  const input = document.getElementById('sheet-url-input');
  const v = input.value.trim();
  const statusEl = document.getElementById('url-status');
  if (!v) { statusEl.textContent = '‚ö† Ingrese la URL primero'; statusEl.className = 'url-status err'; return; }
  if (!v.includes('script.google.com')) { statusEl.textContent = '‚ö† La URL no parece correcta'; statusEl.className = 'url-status err'; return; }
  localStorage.setItem(SHEET_URL_KEY, v);
  statusEl.textContent = '‚úì URL guardada correctamente';
  statusEl.className = 'url-status ok';
  setTimeout(() => statusEl.textContent = '', 3000);
}

// Pre-fill URL field on load
window.addEventListener('DOMContentLoaded', () => {
  const url = getSheetUrl();
  const input = document.getElementById('sheet-url-input');
  if (!localStorage.getItem(SHEET_URL_KEY)) localStorage.setItem(SHEET_URL_KEY, 'https://script.google.com/macros/s/AKfycbwvimLL3DM70rOD1_WvFwgBLeWiPKqaftODpR3U9XAU2aeY45uALX8QOpuTuMkF8QaB/exec');
  if (url) {
    input.value = url;
    document.getElementById('url-status').textContent = '‚úì URL configurada';
    document.getElementById('url-status').className = 'url-status ok';
  }
  // Also save on any input change as backup
  input.addEventListener('input',  () => { if(input.value.trim()) localStorage.setItem(SHEET_URL_KEY, input.value.trim()); });
  input.addEventListener('paste',  () => setTimeout(() => { if(input.value.trim()) localStorage.setItem(SHEET_URL_KEY, input.value.trim()); }, 80));
  input.addEventListener('change', () => { if(input.value.trim()) localStorage.setItem(SHEET_URL_KEY, input.value.trim()); });
  requestNotificationPermission();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkPin() {
  // Guardar URL ANTES de validar PIN
  const urlInput = document.getElementById('sheet-url-input');
  if (urlInput.value.trim()) localStorage.setItem(SHEET_URL_KEY, urlInput.value.trim());

  const code = ['p1','p2','p3','p4'].map(id => document.getElementById(id).value).join('');
  if (code === PIN) {
    document.getElementById('pin-screen').classList.add('hidden');
    document.getElementById('app').classList.add('visible');
    loadData();
    startAutoRefresh();
  } else {
    document.getElementById('pin-error').style.display = 'block';
    ['p1','p2','p3','p4'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('p1').focus();
    setTimeout(() => document.getElementById('pin-error').style.display = 'none', 3000);
  }
}
['p1','p2','p3','p4'].forEach((id, i) => {
  const ids = ['p1','p2','p3','p4'];
  const el  = document.getElementById(id);
  el.addEventListener('input', () => {
    if (el.value.length === 1 && i < 3) document.getElementById(ids[i+1]).focus();
    if (i === 3 && el.value.length === 1) checkPin();
  });
  el.addEventListener('keydown', e => {
    if (e.key === 'Backspace' && !el.value && i > 0) document.getElementById(ids[i-1]).focus();
    if (e.key === 'Enter') checkPin();
  });
});
document.getElementById('p1').focus();

function logout() {
  clearInterval(autoRefreshTimer);
  document.getElementById('app').classList.remove('visible');
  document.getElementById('pin-screen').classList.remove('hidden');
  ['p1','p2','p3','p4'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('p1').focus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
setInterval(() => {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('es-CO',{hour12:false});
}, 1000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadData(silent=false) {
  if (!silent) showLoading('Sincronizando con Google Sheets...');
  const url = getSheetUrl();
  if (url) {
    try {
      // Usar script tag din√°mico para evitar CORS (JSONP style)
      const json = await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        const cbName = '_scatCb_' + Date.now();
        window[cbName] = (data) => {
          delete window[cbName];
          script.remove();
          resolve(data);
        };
        script.onerror = () => reject(new Error('Script error'));
        script.src = url + '?action=getAll&callback=' + cbName;
        setTimeout(() => reject(new Error('Timeout')), 8000);
        document.head.appendChild(script);
      });
      if (json.status === 'ok') {
        activeData = json.active || [];
        closedData = json.closed || [];
        localStorage.setItem(LOCAL_KEY,   JSON.stringify(activeData));
        localStorage.setItem(CLOSED_KEY,  JSON.stringify(closedData));
        const now = new Date();
        document.getElementById('sync-tag').textContent = 'sync ' + now.toLocaleTimeString('es-CO',{hour12:false,hour:'2-digit',minute:'2-digit'});
      } else throw new Error();
    } catch {
      activeData = JSON.parse(localStorage.getItem(LOCAL_KEY)  || '[]').filter(r => r.estado !== 'cerrado');
      closedData = JSON.parse(localStorage.getItem(CLOSED_KEY) || '[]');
      document.getElementById('sync-tag').textContent = '‚ö† sin sync';
    }
  } else {
    activeData = JSON.parse(localStorage.getItem(LOCAL_KEY)  || '[]').filter(r => r.estado !== 'cerrado');
    closedData = JSON.parse(localStorage.getItem(CLOSED_KEY) || '[]');
    document.getElementById('sync-tag').textContent = 'üìÅ local';
  }
  hideLoading();
  renderAll();
  checkAlerts();
}

async function closeRecord(id, action, record) {
  const entry = { ...record, cierre: new Date().toISOString(), accion: action, cerrado_por: 'Admin Dashboard' };
  activeData = activeData.filter(r => String(r.id) !== String(id));
  closedData.push(entry);
  localStorage.setItem(LOCAL_KEY,  JSON.stringify(activeData));
  localStorage.setItem(CLOSED_KEY, JSON.stringify(closedData));
  renderAll();
  const url = getSheetUrl();
  if (url) {
    try {
      await fetch(url, { method:'POST', body:JSON.stringify({ action:'close', id, closedEntry:entry }), headers:{'Content-Type':'text/plain'} });
    } catch {}
  }
}

function startAutoRefresh() {
  clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(() => loadData(true), 60000);
}
function forceRefresh() { loadData(false); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TURNO & DOBLEZ LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getHours(iso) { return (Date.now() - new Date(iso)) / 3600000; }
function fmtHours(h)   { return `${Math.floor(h)}h ${Math.round((h%1)*60)}m`; }
function fmtDate(iso)  { if(!iso) return '‚Äî'; return new Date(iso).toLocaleString('es-CO',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); }
function fmtDateShort(iso) { if(!iso) return '‚Äî'; return new Date(iso).toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function subClass(s)   { return s==='Norte'?'norte':s==='Sur'?'sur':s==='Sur Occidente'?'suroc':s==='Centro Oriente'?'co':''; }
function todayStr()    { return new Date().toISOString().slice(0,10); }

// Estado basado en 12h de turno
// ok: < 11h | warn: 11-12h (por vencer) | dob: > 12h (doblando) | crit: > 24h (cr√≠tico)
function getShiftStatus(h) {
  if (h > 24)  return 'crit';
  if (h > 12)  return 'dob';
  if (h >= 11) return 'warn';
  return 'ok';
}

// Contar cu√°ntos turnos consecutivos tiene una c√©dula en historial reciente (√∫ltimas 48h)
function countConsecutiveTurnos(cedula) {
  if (!cedula) return 0;
  const cutoff = Date.now() - 48 * 3600000;
  const recent = closedData.filter(r => {
    const t = new Date(r.cierre || r.inicio).getTime();
    return t >= cutoff && (r.con_cedula === cedula || r.aux_cedula === cedula || r.med_cedula === cedula);
  });
  return recent.length;
}

// Verificar si alg√∫n tripulante de un registro activo ya trabaj√≥ antes
function getDobladoInfo(record) {
  const cedulas = [
    { cedula: record.con_cedula, nombre: record.con_nombre, rol: 'Conductor' },
    { cedula: record.aux_cedula, nombre: record.aux_nombre, rol: 'Auxiliar' },
    { cedula: record.med_cedula, nombre: record.med_nombre, rol: 'M√©dico' },
  ].filter(p => p.cedula);

  let maxTurnos = 0;
  let doblados = [];

  cedulas.forEach(p => {
    const n = countConsecutiveTurnos(p.cedula);
    if (n > 0) {
      doblados.push({ ...p, turnos: n + 1 }); // +1 porque el actual es el turno siguiente
      if (n + 1 > maxTurnos) maxTurnos = n + 1;
    }
  });

  return { maxTurnos, doblados };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTS & NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
}

function checkAlerts() {
  const crits   = activeData.filter(r => getShiftStatus(getHours(r.inicio)) === 'crit');
  const dobs    = activeData.filter(r => {
    const st = getShiftStatus(getHours(r.inicio));
    return st === 'dob' || getDobladoInfo(r).maxTurnos >= 2;
  });

  const critBanner = document.getElementById('alert-crit');
  if (crits.length) {
    critBanner.classList.add('show');
    document.getElementById('alert-crit-title').textContent = `‚õî ${crits.length} m√≥vil(es) superando 24 horas`;
    document.getElementById('alert-crit-msg').textContent = crits.map(r=>`${r.placa} (${r.subred}) ‚Äî ${fmtHours(getHours(r.inicio))}`).join(' ¬∑ ');
  } else critBanner.classList.remove('show');

  const dobBanner = document.getElementById('alert-dob');
  if (dobs.length) {
    dobBanner.classList.add('show');
    document.getElementById('alert-dob-title').textContent = `‚ö†Ô∏è ${dobs.length} m√≥vil(es) con personal doblando turno`;
    document.getElementById('alert-dob-msg').textContent = dobs.map(r=>`${r.placa} ‚Äî ${fmtHours(getHours(r.inicio))}`).join(' ¬∑ ');
  } else dobBanner.classList.remove('show');
}

function sendNotification(type) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  if (type === 'crit') {
    const crits = activeData.filter(r => getShiftStatus(getHours(r.inicio)) === 'crit');
    new Notification('üöë SCAT ‚Äî M√≥viles Cr√≠ticas', { body: crits.map(r=>`${r.placa} ¬∑ ${r.subred} ¬∑ ${fmtHours(getHours(r.inicio))}`).join('\n'), tag:'scat-crit', requireInteraction:true });
  } else {
    const dobs = activeData.filter(r => getShiftStatus(getHours(r.inicio)) === 'dob');
    new Notification('‚ö†Ô∏è SCAT ‚Äî Personal Doblado', { body: dobs.map(r=>`${r.placa} ¬∑ ${r.subred}`).join('\n'), tag:'scat-dob' });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() { renderKPI(); renderTable(); renderSubredes(); renderHistorial(); }

function renderKPI() {
  const crit  = activeData.filter(r => getShiftStatus(getHours(r.inicio)) === 'crit').length;
  const dob   = activeData.filter(r => getShiftStatus(getHours(r.inicio)) === 'dob').length;
  const warn  = activeData.filter(r => getShiftStatus(getHours(r.inicio)) === 'warn').length;
  const ok    = activeData.filter(r => getShiftStatus(getHours(r.inicio)) === 'ok').length;
  document.getElementById('kpi-row').innerHTML = `
    <div class="kpi-card k-total"><div class="kpi-num">${activeData.length}</div><div class="kpi-label">M√≥viles Activas</div><div class="kpi-sub">En este momento</div></div>
    <div class="kpi-card k-ok"><div class="kpi-num">${ok}</div><div class="kpi-label">Normal</div><div class="kpi-sub">Menos de 11h</div></div>
    <div class="kpi-card k-warn"><div class="kpi-num">${warn}</div><div class="kpi-label">Por Vencer</div><div class="kpi-sub">Entre 11h y 12h</div></div>
    <div class="kpi-card k-dob"><div class="kpi-num">${dob}</div><div class="kpi-label">Doblando</div><div class="kpi-sub">M√°s de 12h</div></div>
    <div class="kpi-card k-crit"><div class="kpi-num">${crit}</div><div class="kpi-label">Cr√≠tico</div><div class="kpi-sub">M√°s de 24h ‚ö†Ô∏è</div></div>`;
}

function renderTable() {
  let recs = [...activeData];
  if (activeFilter !== 'all') recs = recs.filter(r => r.subred === activeFilter);
  if (statusFilter === 'crit') recs = recs.filter(r => getShiftStatus(getHours(r.inicio)) === 'crit');
  if (statusFilter === 'dob')  recs = recs.filter(r => getShiftStatus(getHours(r.inicio)) === 'dob' || getDobladoInfo(r).maxTurnos >= 2);
  if (statusFilter === 'warn') recs = recs.filter(r => getShiftStatus(getHours(r.inicio)) === 'warn');
  if (searchQuery) recs = recs.filter(r => (r.placa||'').toUpperCase().includes(searchQuery.toUpperCase()) || (r.con_nombre||'').toLowerCase().includes(searchQuery.toLowerCase()));
  recs.sort((a,b) => getHours(b.inicio) - getHours(a.inicio));

  const empty = document.getElementById('main-empty');
  const tbody = document.getElementById('main-tbody');
  if (!recs.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = recs.map(r => {
    const h    = getHours(r.inicio);
    const st   = getShiftStatus(h);
    const dInfo = getDobladoInfo(r);
    const rowCls = st==='crit'?'r-crit':st==='dob'?'r-dob':st==='warn'?'r-warn':'';

    const statusLabel = st==='crit'?'üî¥ DETENER M√ìVIL': st==='dob'?'üü† DOBLANDO TURNO': st==='warn'?'üü° POR VENCER':'‚úÖ Normal';

    // Personal column: show doblado badges
    const personalHTML = buildPersonalBadges(r, dInfo);

    const medCell = r.med_nombre
      ? `<div class="person-block"><span class="person-name">${r.med_nombre}</span><span class="person-doc">${r.med_cedula||'‚Äî'}</span></div>`
      : `<span class="na-tag">N/A</span>`;

    const btn = st==='crit'
      ? `<button class="btn-action btn-detener" onclick="openModal('${r.id}','detener')">üõë Detener</button>`
      : `<button class="btn-action btn-cerrar" onclick="openModal('${r.id}','cerrar')">‚úì Cerrar</button>`;

    return `<tr class="${rowCls}">
      <td><span class="b-subred ${subClass(r.subred)}">${r.subred}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:600">${r.placa}</td>
      <td><span class="b-tipo">${r.tipo}</span></td>
      <td>${medCell}</td>
      <td><div class="person-block"><span class="person-name">${r.con_nombre}</span><span class="person-doc">${r.con_cedula||'‚Äî'}</span></div></td>
      <td><div class="person-block"><span class="person-name">${r.aux_nombre}</span><span class="person-doc">${r.aux_cedula||'‚Äî'}</span></div></td>
      <td style="font-size:0.74rem;color:var(--text-sub)">${r.turno}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.71rem;color:var(--text-sub)">${fmtDate(r.inicio)}</td>
      <td><span class="hours-tag ${st}">${fmtHours(h)}</span></td>
      <td><span class="status-chip ${st}">${statusLabel}</span></td>
      <td>${personalHTML}</td>
      <td style="font-size:0.74rem;color:var(--text-muted);max-width:110px">${r.referente||'‚Äî'}</td>
      <td>${btn}</td>
    </tr>`;
  }).join('');
}

function buildPersonalBadges(r, dInfo) {
  if (!dInfo || !dInfo.doblados.length) return '<span style="font-size:0.72rem;color:var(--green)">‚úÖ Normal</span>';
  return dInfo.doblados.map(p => {
    const cls = p.turnos >= 3 ? 'd2' : 'd1';
    const label = p.turnos >= 3 ? `üî¥ ${p.rol} ‚Äî ${p.turnos}er turno` : `üü† ${p.rol} ‚Äî 2do turno`;
    return `<span class="b-doblado ${cls}">${label}</span>`;
  }).join('<br>');
}

function renderSubredes() {
  const subredes = [
    {name:'Norte',color:'#60A5FA'},{name:'Sur',color:'#4ADE80'},
    {name:'Sur Occidente',color:'#FCD34D'},{name:'Centro Oriente',color:'#C084FC'},
  ];
  document.getElementById('subred-grid').innerHTML = subredes.map(s => {
    const rows = activeData.filter(r => r.subred === s.name).sort((a,b)=>getHours(b.inicio)-getHours(a.inicio));
    const crit = rows.filter(r=>getShiftStatus(getHours(r.inicio))==='crit').length;
    const dob  = rows.filter(r=>getShiftStatus(getHours(r.inicio))==='dob').length;
    const warn = rows.filter(r=>getShiftStatus(getHours(r.inicio))==='warn').length;
    const okC  = rows.length - crit - dob - warn;

    const rowsHTML = rows.length ? rows.map(r => {
      const h = getHours(r.inicio); const st = getShiftStatus(h);
      const dInfo = getDobladoInfo(r);
      return `<div class="subred-row ${st==='crit'?'r-crit':st==='dob'?'r-dob':st==='warn'?'r-warn':''}">
        <div class="subred-row-top">
          <span class="subred-row-placa">${r.placa}</span>
          <span class="b-tipo">${r.tipo}</span>
          <span class="hours-tag ${st}" style="margin-left:auto">${fmtHours(h)}</span>
        </div>
        <div class="subred-row-people">
          ${r.med_nombre?`<div class="subred-row-person"><span class="srp-role med">M√©dico</span><span class="srp-name">${r.med_nombre}</span></div>`:''}
          <div class="subred-row-person">
            <span class="srp-role con">Conductor</span>
            <span class="srp-name">${r.con_nombre}</span>
            <span class="srp-doc">${r.con_cedula}</span>
            ${dInfo.doblados.find(d=>d.cedula===r.con_cedula)?`<span class="b-doblado ${dInfo.doblados.find(d=>d.cedula===r.con_cedula).turnos>=3?'d2':'d1'}">DOBLADO</span>`:''}
          </div>
          <div class="subred-row-person">
            <span class="srp-role aux">Auxiliar</span>
            <span class="srp-name">${r.aux_nombre}</span>
            <span class="srp-doc">${r.aux_cedula}</span>
            ${dInfo.doblados.find(d=>d.cedula===r.aux_cedula)?`<span class="b-doblado ${dInfo.doblados.find(d=>d.cedula===r.aux_cedula).turnos>=3?'d2':'d1'}">DOBLADO</span>`:''}
          </div>
        </div>
      </div>`;
    }).join('') : `<div style="text-align:center;padding:1.5rem;color:var(--text-muted);font-size:0.82rem">Sin m√≥viles activas</div>`;

    return `<div class="subred-panel">
      <div class="subred-panel-head">
        <div class="subred-panel-dot" style="background:${s.color}"></div>
        <div class="subred-panel-name" style="color:${s.color}">Subred ${s.name}</div>
        <div class="subred-panel-count">
          ${okC>0?`<span class="mini-count ok">${okC} ok</span>`:''}
          ${warn>0?`<span class="mini-count warn">${warn} venc</span>`:''}
          ${dob>0?`<span class="mini-count dob">${dob} dob</span>`:''}
          ${crit>0?`<span class="mini-count crit">${crit} crit</span>`:''}
        </div>
      </div>
      <div class="subred-panel-body">${rowsHTML}</div>
    </div>`;
  }).join('');
}

function renderHistorial() {
  const now = new Date();
  let recs = [...closedData];
  const startOf = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
  const endOf   = d => { const x=new Date(d); x.setHours(23,59,59,999); return x; };

  if (dayFilter==='today') {
    const s=startOf(now), e=endOf(now);
    recs = recs.filter(r=>{ const d=new Date(r.cierre||r.inicio); return d>=s&&d<=e; });
  } else if (dayFilter==='yesterday') {
    const y=new Date(now); y.setDate(y.getDate()-1);
    const s=startOf(y), e=endOf(y);
    recs = recs.filter(r=>{ const d=new Date(r.cierre||r.inicio); return d>=s&&d<=e; });
  } else if (dayFilter==='week') {
    const s=new Date(now); s.setDate(s.getDate()-7);
    recs = recs.filter(r=>new Date(r.cierre||r.inicio)>=s);
  } else if (dayFilter==='custom') {
    const from=document.getElementById('date-from').value;
    const to=document.getElementById('date-to').value;
    if (from) recs=recs.filter(r=>new Date(r.cierre||r.inicio)>=new Date(from));
    if (to)   recs=recs.filter(r=>new Date(r.cierre||r.inicio)<=endOf(new Date(to)));
  }

  const tbody=document.getElementById('hist-tbody');
  const empty=document.getElementById('hist-empty');
  if (!recs.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';

  tbody.innerHTML=[...recs].reverse().map(r=>{
    const total=r.cierre?((new Date(r.cierre)-new Date(r.inicio))/3600000):0;
    const st=total>24?'crit':total>12?'dob':total>=11?'warn':'ok';
    return `<tr class="closed-row">
      <td style="font-size:0.72rem;white-space:nowrap">${fmtDateShort(r.cierre||r.inicio)}</td>
      <td><span class="b-subred ${subClass(r.subred)}">${r.subred}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;font-weight:600">${r.placa}</td>
      <td><span class="b-tipo">${r.tipo}</span></td>
      <td style="font-size:0.78rem">${r.con_nombre}</td>
      <td style="font-size:0.78rem">${r.aux_nombre}</td>
      <td style="font-size:0.78rem">${r.med_nombre||'N/A'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.72rem">${fmtDate(r.inicio)}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:0.72rem">${fmtDate(r.cierre)}</td>
      <td><span class="hours-tag ${st}">${fmtHours(total)}</span></td>
      <td style="font-size:0.75rem;font-weight:700;color:${r.accion==='detener'?'var(--red)':'var(--green)'}">${r.accion==='detener'?'üõë DETENIDA':'‚úì Normal'}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS & TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFilter(val,btn) {
  activeFilter=val; statusFilter=null; searchQuery='';
  document.querySelectorAll('#toolbar .filter-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('search-box').value='';
  renderTable();
}
function setStatusFilter(type,btn) {
  statusFilter = statusFilter===type ? null : type;
  activeFilter='all';
  document.querySelectorAll('#toolbar .filter-chip').forEach(b=>b.classList.remove('active'));
  if (statusFilter) btn.classList.add('active');
  else document.querySelector('#toolbar .filter-chip').classList.add('active');
  renderTable();
}
function searchFilter(v) { searchQuery=v; renderTable(); }
function setDayFilter(type,btn) {
  dayFilter=type;
  document.querySelectorAll('.day-chip').forEach(b=>b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderHistorial();
}
function showTab(name,btn) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id, action) {
  const r = activeData.find(x => String(x.id)===String(id));
  if (!r) return;
  pendingAction = { id, action, record:r };
  const h = getHours(r.inicio);
  const dInfo = getDobladoInfo(r);

  document.getElementById('modal-title').textContent = action==='detener' ? 'üõë Detener M√≥vil' : '‚úì Cerrar Turno';
  document.getElementById('modal-sub').textContent   = action==='detener'
    ? `Esta m√≥vil lleva ${fmtHours(h)} activa ‚Äî supera las 24h.`
    : `Confirme el cierre del turno de ${fmtHours(h)}.`;

  // Doblado warning
  const dobWarn = document.getElementById('modal-dob-warn');
  if (dInfo.doblados.length) {
    dobWarn.style.display = 'block';
    dobWarn.innerHTML = `‚ö†Ô∏è <strong>Personal doblando turno:</strong><br>` +
      dInfo.doblados.map(p=>`${p.rol}: ${p.nombre} ‚Äî este es su <strong>${p.turnos}¬∞ turno consecutivo</strong>`).join('<br>');
  } else dobWarn.style.display = 'none';

  document.getElementById('modal-detail').innerHTML =
    `<strong>${r.placa} ¬∑ ${r.tipo} ¬∑ Subred ${r.subred}</strong>
    Conductor: ${r.con_nombre} (CC ${r.con_cedula})<br>
    Auxiliar: ${r.aux_nombre} (CC ${r.aux_cedula})<br>
    ${r.med_nombre?'M√©dico: '+r.med_nombre+'<br>':''}
    Inicio: ${fmtDate(r.inicio)} ¬∑ ${fmtHours(h)} activo`;

  const btn = document.getElementById('modal-confirm-btn');
  btn.textContent = action==='detener' ? 'üõë Confirmar ‚Äî Detener' : '‚úì Confirmar Cierre';
  btn.className = action==='detener' ? 'btn-modal-detener' : 'btn-modal-confirm';
  btn.onclick = confirmAction;
  document.getElementById('modal-overlay').classList.add('open');
}

async function confirmAction() {
  if (!pendingAction) return;
  const btn = document.getElementById('modal-confirm-btn');
  btn.innerHTML = '<span class="spinner"></span>Guardando...';
  btn.disabled = true;
  await closeRecord(pendingAction.id, pendingAction.action, pendingAction.record);
  btn.disabled = false;
  closeModal();
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); pendingAction=null; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportExcel() {
  const recs = [...activeData].sort((a,b)=>getHours(b.inicio)-getHours(a.inicio));
  const headers = ['Subred','Placa','Tipo','Turno','Inicio','Horas en turno','Estado','Personal doblado','M√©dico','Ced.M√©dico','Conductor','Ced.Conductor','Auxiliar','Ced.Auxiliar','Referente','Observaciones'];
  const rows = recs.map(r => {
    const h=getHours(r.inicio); const st=getShiftStatus(h);
    const dInfo=getDobladoInfo(r);
    const stLabel = st==='crit'?'DETENER':st==='dob'?'DOBLANDO':st==='warn'?'POR VENCER':'Normal';
    const dobLabel = dInfo.doblados.length ? dInfo.doblados.map(p=>`${p.rol}: ${p.nombre} (${p.turnos}¬∞ turno)`).join(' | ') : 'No';
    return [r.subred,r.placa,r.tipo,r.turno,fmtDate(r.inicio),fmtHours(h),stLabel,dobLabel,r.med_nombre||'N/A',r.med_cedula||'',r.con_nombre,r.con_cedula,r.aux_nombre,r.aux_cedula,r.referente||'‚Äî',r.observaciones||''];
  });
  downloadCSV([headers,...rows], `SCAT_Activas_${todayStr()}`);
}

function exportHistorialExcel() {
  const headers = ['Fecha','Subred','Placa','Tipo','Inicio','Cierre','Total Horas','Conductor','Auxiliar','M√©dico','Resultado'];
  const rows = [...closedData].reverse().map(r => {
    const total=r.cierre?((new Date(r.cierre)-new Date(r.inicio))/3600000):0;
    return [fmtDateShort(r.cierre||r.inicio),r.subred,r.placa,r.tipo,fmtDate(r.inicio),fmtDate(r.cierre),fmtHours(total),r.con_nombre,r.aux_nombre,r.med_nombre||'N/A',r.accion==='detener'?'DETENIDA':'Normal'];
  });
  downloadCSV([headers,...rows], `SCAT_Historial_${todayStr()}`);
}

function downloadCSV(rows, name) {
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name+'.csv'; a.click();
}

function exportTxt() {
  const recs = [...activeData].sort((a,b)=>getHours(b.inicio)-getHours(a.inicio));
  let txt = `REPORTE SCAT ‚Äî ${new Date().toLocaleString('es-CO')}\n${'‚ïê'.repeat(60)}\n\n`;
  ['Norte','Sur','Sur Occidente','Centro Oriente'].forEach(s=>{
    const rows=recs.filter(r=>r.subred===s);
    txt+=`SUBRED ${s.toUpperCase()} (${rows.length})\n${'‚îÄ'.repeat(40)}\n`;
    rows.forEach(r=>{
      const h=getHours(r.inicio); const st=getShiftStatus(h);
      const icon=st==='crit'?'üî¥':st==='dob'?'üü†':st==='warn'?'üü°':'‚úÖ';
      txt+=`\n  ${icon} ${r.placa} (${r.tipo}) ¬∑ ${fmtHours(h)}\n`;
      if(r.med_nombre) txt+=`  M√©dico:    ${r.med_nombre} ¬∑ CC ${r.med_cedula}\n`;
      txt+=`  Conductor: ${r.con_nombre} ¬∑ CC ${r.con_cedula}\n`;
      txt+=`  Auxiliar:  ${r.aux_nombre} ¬∑ CC ${r.aux_cedula}\n`;
      const dInfo=getDobladoInfo(r);
      if(dInfo.doblados.length) txt+=`  ‚ö†Ô∏è DOBLADOS: ${dInfo.doblados.map(p=>`${p.rol} ${p.nombre} (${p.turnos}¬∞ turno)`).join(', ')}\n`;
    });
    txt+='\n';
  });
  const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`Reporte_${todayStr()}.txt`; a.click();
}

function clearClosed() {
  if (!confirm('¬øLimpiar historial visible? No se puede deshacer.')) return;
  closedData=[]; localStorage.removeItem(CLOSED_KEY); renderHistorial();
}

function showLoading(msg) { document.getElementById('loading-text').textContent=msg||'Cargando...'; document.getElementById('loading-overlay').classList.add('show'); }
function hideLoading() { document.getElementById('loading-overlay').classList.remove('show'); }
</script>
</body>
</html>
