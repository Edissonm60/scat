<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Registro de Turno ¬∑ SCAT</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F0F4FF;--white:#fff;--surface:#F8FAFF;
  --border:#DDE3F0;--focus:#2563EB;
  --text:#0F172A;--sub:#475569;--muted:#94A3B8;
  --accent:#2563EB;--accent-l:#EFF6FF;
  --green:#16A34A;--green-l:#F0FDF4;
  --red:#DC2626;--yellow:#D97706;--yellow-l:#FFFBEB;
  --orange:#F97316;
  --r:16px;--rs:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:60px;}

/* HEADER */
.hdr{background:var(--accent);position:sticky;top:0;z-index:50;box-shadow:0 2px 16px rgba(37,99,235,.4);}
.hdr-in{max-width:600px;margin:0 auto;padding:13px 18px;display:flex;align-items:center;gap:12px;}
.hdr-ico{width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1.15rem;flex-shrink:0;}
.hdr-t h1{font-size:.92rem;font-weight:700;color:#fff;}
.hdr-t p{font-size:.65rem;color:rgba(255,255,255,.75);margin-top:1px;}

/* PROGRESS */
.prg{max-width:600px;margin:0 auto;padding:14px 18px 0;}
.prg-steps{display:flex;align-items:center;gap:5px;}
.prg-item{display:flex;align-items:center;gap:4px;flex:1;}
.prg-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;flex-shrink:0;border:2px solid var(--border);background:var(--white);color:var(--muted);transition:all .25s;}
.prg-dot.active{border-color:var(--accent);background:var(--accent);color:#fff;box-shadow:0 0 0 3px rgba(37,99,235,.15);}
.prg-dot.done{border-color:var(--green);background:var(--green);color:#fff;}
.prg-lbl{font-size:.58rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;}
.prg-lbl.active{color:var(--accent);}
.prg-line{flex:1;height:2px;background:var(--border);border-radius:2px;}
.prg-line.done{background:var(--green);}

/* CARDS */
.wrap{max-width:600px;margin:0 auto;padding:14px 16px;}
.card{background:var(--white);border-radius:var(--r);box-shadow:0 3px 14px rgba(0,0,0,.07);margin-bottom:14px;border:1px solid var(--border);display:none;}
.card.show{display:block;}
.card-hd{padding:14px 18px 11px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.card-num{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:800;flex-shrink:0;}
.num-blue{background:var(--accent-l);color:var(--accent);}
.num-green{background:var(--green-l);color:var(--green);}
.num-purple{background:#F3E8FF;color:#7C3AED;}
.card-title{font-size:.9rem;font-weight:700;}
.card-sub{font-size:.65rem;color:var(--muted);margin-top:1px;}
.card-body{padding:16px 18px;}

/* FIELDS */
.field{display:flex;flex-direction:column;gap:5px;margin-bottom:12px;}
.field:last-child{margin-bottom:0;}
.field label{font-size:.76rem;font-weight:600;color:var(--sub);}
.field input,.field select,.field textarea{
  padding:11px 13px;border:1.5px solid var(--border);border-radius:var(--rs);
  font-family:'Outfit',sans-serif;font-size:.9rem;color:var(--text);
  background:var(--white);outline:none;width:100%;transition:border-color .2s;
}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
.field textarea{resize:none;height:64px;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:480px){.row2{grid-template-columns:1fr;}}
.req{color:var(--red);}
.ferr{font-size:.7rem;color:var(--red);display:none;margin-top:2px;}
.has-err input,.has-err select{border-color:var(--red)!important;}
.has-err .ferr{display:block;}

/* TIPO */
.tipo-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;}
.tipo-opt{position:relative;}
.tipo-opt input{position:absolute;opacity:0;width:0;height:0;}
.tipo-opt label{display:flex;align-items:center;gap:13px;padding:12px 15px;border:2px solid var(--border);border-radius:var(--rs);cursor:pointer;background:var(--surface);transition:all .2s;}
.tipo-opt input:checked+label{border-color:var(--accent);background:var(--accent-l);}
.tipo-opt input:checked+label .tn{color:var(--accent);}
.ti{font-size:1.4rem;flex-shrink:0;}
.tn{font-size:.86rem;font-weight:700;}
.td{font-size:.68rem;color:var(--muted);margin-top:1px;}

/* TURNO */
.turno-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.turno-opt{position:relative;}
.turno-opt input{position:absolute;opacity:0;width:0;height:0;}
.turno-opt label{display:flex;align-items:center;gap:10px;padding:12px 14px;border:2px solid var(--border);border-radius:var(--rs);cursor:pointer;background:var(--surface);transition:all .2s;}
.turno-opt input:checked+label{border-color:var(--accent);background:var(--accent-l);}
.turno-name{font-size:.84rem;font-weight:700;}
.turno-time{font-size:.67rem;color:var(--muted);}

/* CREW */
.crew{border:1.5px solid var(--border);border-radius:var(--rs);margin-bottom:10px;overflow:hidden;}
.crew.hide{display:none;}
.crew-hd{display:flex;align-items:center;gap:11px;padding:12px 15px;cursor:pointer;background:var(--surface);user-select:none;}
.crew-av{width:33px;height:33px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.95rem;flex-shrink:0;}
.av-med{background:#EFF6FF;} .av-con{background:#F0FDF4;} .av-aux{background:#FFF7ED;}
.crew-info{flex:1;}
.crew-role{font-size:.82rem;font-weight:700;}
.crew-note{font-size:.66rem;color:var(--muted);margin-top:1px;}
.crew-chev{color:var(--muted);font-size:.68rem;transition:transform .2s;}
.crew-bd{display:none;padding:14px;border-top:1px solid var(--border);}
.crew.open .crew-bd{display:block;}
.crew.open .crew-chev{transform:rotate(180deg);}

/* PHOTO */
.photo-box{border:2px dashed var(--border);border-radius:var(--rs);padding:14px;text-align:center;cursor:pointer;position:relative;background:var(--surface);transition:all .2s;margin-top:4px;}
.photo-box input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.photo-box:hover{border-color:var(--accent);background:var(--accent-l);}
.photo-box.ok{border-color:var(--green);background:var(--green-l);border-style:solid;}
.ph-ico{font-size:1.3rem;margin-bottom:2px;}
.ph-txt{font-size:.76rem;color:var(--sub);}
.ph-hint{font-size:.63rem;color:var(--muted);margin-top:2px;}
.ph-st{font-size:.7rem;font-weight:600;margin-top:4px;display:none;}
.ph-st.ok{color:var(--green);display:block;}

/* DOBLADO */
.dob-alert{display:none;background:#FFF7ED;border:2px solid #F97316;border-radius:12px;padding:12px 14px;margin-top:10px;}

/* NAV */
.nav{display:flex;gap:10px;margin-top:14px;}
.btn-back{padding:11px 15px;border:1.5px solid var(--border);border-radius:var(--rs);background:var(--white);color:var(--sub);font-family:'Outfit',sans-serif;font-size:.84rem;font-weight:600;cursor:pointer;}
.btn-next{flex:1;padding:12px;border-radius:var(--rs);border:none;background:var(--accent);color:#fff;font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:background .2s;}
.btn-next:hover{background:#1D4ED8;}
.btn-next:active{background:#1E40AF;}
.err-msg{font-size:.7rem;color:var(--red);display:none;margin-bottom:8px;}

/* MODAL CONFIRM */
.modal-bg{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);align-items:flex-end;justify-content:center;}
.modal-bg.open{display:flex;}
.modal-box{background:var(--white);border-radius:20px 20px 0 0;padding:24px 20px;width:100%;max-width:600px;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-title{font-size:1.05rem;font-weight:800;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.modal-rows{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;max-height:55vh;overflow-y:auto;}
.mcard{background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);padding:11px 14px;}
.mcard-title{font-size:.72rem;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;}
.mrow{display:flex;justify-content:space-between;font-size:.79rem;padding:2px 0;border-bottom:1px solid var(--border);}
.mrow:last-child{border-bottom:none;}
.mkey{color:var(--muted);}
.mval{font-weight:600;text-align:right;max-width:55%;}
.modal-warn{background:var(--yellow-l);border:1.5px solid #FCD34D;border-radius:var(--rs);padding:10px 12px;font-size:.74rem;color:#92400E;margin-bottom:14px;line-height:1.5;}
.btn-confirm{width:100%;padding:14px;border:none;border-radius:var(--rs);background:var(--green);color:#fff;font-family:'Outfit',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-confirm:disabled{background:#6B7280;cursor:not-allowed;}
.btn-modal-cancel{width:100%;padding:11px;border:1.5px solid var(--border);border-radius:var(--rs);background:var(--white);color:var(--sub);font-family:'Outfit',sans-serif;font-size:.84rem;font-weight:600;cursor:pointer;margin-top:8px;}

/* SUCCESS */
.success{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;padding:40px 20px;text-align:center;}
.success.show{display:flex;}
.s-circle{width:72px;height:72px;border-radius:50%;border:3px solid var(--green);display:flex;align-items:center;justify-content:center;font-size:1.7rem;color:var(--green);margin-bottom:16px;background:var(--green-l);}
.s-title{font-size:1.45rem;font-weight:800;margin-bottom:6px;}
.s-sub{font-size:.86rem;color:var(--muted);margin-bottom:16px;}
.s-detail{background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);padding:14px 18px;font-size:.82rem;line-height:1.8;max-width:380px;width:100%;}
.s-sync{font-size:.68rem;margin-top:8px;font-family:monospace;}
.s-sync.ok{color:var(--green);}
.s-sync.warn{color:var(--yellow);}
.btn-new{padding:13px 24px;border-radius:var(--rs);border:none;background:var(--accent);color:#fff;font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;margin-top:1.2rem;}

.spin{width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}
.footer{text-align:center;padding:18px;font-size:.62rem;color:var(--muted);}
.footer strong{color:var(--accent);}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-in">
    <div class="hdr-ico">üöë</div>
    <div class="hdr-t">
      <h1>Registro de Turno ¬∑ SCAT</h1>
      <p>Secretar√≠a de Salud ¬∑ Bogot√° D.C.</p>
    </div>
  </div>
</div>

<div class="prg">
  <div class="prg-steps">
    <div class="prg-item"><div class="prg-dot active" id="d1">1</div><div class="prg-lbl active" id="l1">M√≥vil</div></div>
    <div class="prg-line" id="ln1"></div>
    <div class="prg-item"><div class="prg-dot" id="d2">2</div><div class="prg-lbl" id="l2">Personal</div></div>
    <div class="prg-line" id="ln2"></div>
    <div class="prg-item"><div class="prg-dot" id="d3">3</div><div class="prg-lbl" id="l3">Referente</div></div>
  </div>
</div>

<div class="wrap">

<!-- PASO 1: M√ìVIL -->
<div class="card show" id="s1">
  <div class="card-hd"><div class="card-num num-blue">01</div><div><div class="card-title">Identificaci√≥n de la M√≥vil</div><div class="card-sub">Datos del veh√≠culo que inicia turno</div></div></div>
  <div class="card-body">
    <div class="row2">
      <div class="field" id="f-subred">
        <label>Subred <span class="req">*</span></label>
        <select id="subred"><option value="">Seleccionar‚Ä¶</option><option>Norte</option><option>Sur</option><option>Sur Occidente</option><option>Centro Oriente</option></select>
        <div class="ferr">Seleccione la subred</div>
      </div>
      <div class="field" id="f-placa">
        <label>Placa / N√∫mero <span class="req">*</span></label>
        <input type="text" id="placa" placeholder="Ej: AMB-001" style="text-transform:uppercase">
        <div class="ferr">Ingrese el n√∫mero de m√≥vil</div>
      </div>
    </div>

    <label style="font-size:.76rem;font-weight:600;color:var(--sub);display:block;margin-bottom:8px">Tipo de M√≥vil <span class="req">*</span></label>
    <div class="tipo-list">
      <div class="tipo-opt"><input type="radio" name="tipo" id="t-med" value="Medicalizada" onchange="onTipo()"><label for="t-med"><span class="ti">üè•</span><div><div class="tn">Medicalizada</div><div class="td">M√©dico + Conductor + Auxiliar</div></div></label></div>
      <div class="tipo-opt"><input type="radio" name="tipo" id="t-bas" value="B√°sica" onchange="onTipo()"><label for="t-bas"><span class="ti">üöë</span><div><div class="tn">B√°sica</div><div class="td">Conductor + Auxiliar</div></div></label></div>
      <div class="tipo-opt"><input type="radio" name="tipo" id="t-mec" value="MED" onchange="onTipo()"><label for="t-mec"><span class="ti">‚öïÔ∏è</span><div><div class="tn">MED</div><div class="td">M√©dico + Auxiliar/Conductor</div></div></label></div>
    </div>
    <div class="err-msg" id="err-tipo">‚ö† Seleccione el tipo de m√≥vil</div>

    <label style="font-size:.76rem;font-weight:600;color:var(--sub);display:block;margin-bottom:8px">Tipo de Turno <span class="req">*</span></label>
    <div class="turno-row">
      <div class="turno-opt"><input type="radio" name="turno" id="tr-dia" value="D√≠a (7am-7pm)"><label for="tr-dia"><span style="font-size:1.2rem">‚òÄÔ∏è</span><div><div class="turno-name">D√≠a</div><div class="turno-time">7:00 am ‚Äì 7:00 pm</div></div></label></div>
      <div class="turno-opt"><input type="radio" name="turno" id="tr-noc" value="Noche (7pm-7am)"><label for="tr-noc"><span style="font-size:1.2rem">üåô</span><div><div class="turno-name">Noche</div><div class="turno-time">7:00 pm ‚Äì 7:00 am</div></div></label></div>
    </div>
    <div class="err-msg" id="err-turno">‚ö† Seleccione el tipo de turno</div>

    <div class="field" id="f-inicio">
      <label>Fecha y hora de inicio <span class="req">*</span></label>
      <input type="datetime-local" id="inicio">
      <div class="ferr">Ingrese la fecha y hora</div>
    </div>

    <div class="nav"><button class="btn-next" style="width:100%" onclick="next(2)">Siguiente ‚Äî Personal ‚Üí</button></div>
  </div>
</div>

<!-- PASO 2: PERSONAL -->
<div class="card" id="s2">
  <div class="card-hd"><div class="card-num num-green">02</div><div><div class="card-title">Personal del Turno</div><div class="card-sub" id="personal-sub">Datos de cada tripulante</div></div></div>
  <div class="card-body">

    <!-- M√âDICO -->
    <div class="crew hide" id="cr-med">
      <div class="crew-hd" onclick="toggleCrew('cr-med')">
        <div class="crew-av av-med">üë®‚Äç‚öïÔ∏è</div>
        <div class="crew-info"><div class="crew-role">M√©dico <span class="req">*</span></div><div class="crew-note" id="n-med">Toca para ingresar datos</div></div>
        <div class="crew-chev">‚ñº</div>
      </div>
      <div class="crew-bd">
        <div class="row2">
          <div class="field" id="f-mn"><label>Nombre completo <span class="req">*</span></label><input type="text" id="med_n" placeholder="Apellidos y nombres"><div class="ferr">Requerido</div></div>
          <div class="field" id="f-mc"><label>C√©dula <span class="req">*</span></label><input type="text" id="med_c" placeholder="Sin puntos" inputmode="numeric"><div class="ferr">Requerido</div></div>
        </div>
        <div class="field">
          <label>Foto c√©dula <span class="req">*</span></label>
          <div class="photo-box" id="pb-med"><input type="file" id="f-med" accept="image/*" capture="environment" onchange="onPhoto(this,'med')"><div class="ph-ico">üì∑</div><div class="ph-txt">Tomar o subir foto de c√©dula</div><div class="ph-hint">Frente de la c√©dula visible</div><div class="ph-st" id="ps-med"></div></div>
          <div class="ferr" id="ef-med">Se requiere foto de c√©dula</div>
        </div>
      </div>
    </div>

    <!-- CONDUCTOR -->
    <div class="crew open" id="cr-con">
      <div class="crew-hd" onclick="toggleCrew('cr-con')">
        <div class="crew-av av-con">üöò</div>
        <div class="crew-info"><div class="crew-role">Conductor <span class="req">*</span> <span id="badge-med-con" style="display:none;background:#F3E8FF;color:#7C3AED;font-size:.6rem;font-weight:700;padding:2px 7px;border-radius:20px;margin-left:4px">Tambi√©n Auxiliar</span></div><div class="crew-note" id="n-con">Toca para ingresar datos</div></div>
        <div class="crew-chev">‚ñº</div>
      </div>
      <div class="crew-bd">
        <div class="row2">
          <div class="field" id="f-cn"><label>Nombre completo <span class="req">*</span></label><input type="text" id="con_n" placeholder="Apellidos y nombres"><div class="ferr">Requerido</div></div>
          <div class="field" id="f-cc"><label>C√©dula <span class="req">*</span></label><input type="text" id="con_c" placeholder="Sin puntos" inputmode="numeric"><div class="ferr">Requerido</div></div>
        </div>
        <div class="field">
          <label>Foto c√©dula <span class="req">*</span></label>
          <div class="photo-box" id="pb-con"><input type="file" id="f-con" accept="image/*" capture="environment" onchange="onPhoto(this,'con')"><div class="ph-ico">üì∑</div><div class="ph-txt">Tomar o subir foto de c√©dula</div><div class="ph-hint">Frente de la c√©dula visible</div><div class="ph-st" id="ps-con"></div></div>
          <div class="ferr" id="ef-con">Se requiere foto de c√©dula</div>
        </div>
      </div>
    </div>

    <!-- AUXILIAR -->
    <div class="crew hide" id="cr-aux">
      <div class="crew-hd" onclick="toggleCrew('cr-aux')">
        <div class="crew-av av-aux">ü©∫</div>
        <div class="crew-info"><div class="crew-role">Auxiliar <span class="req">*</span></div><div class="crew-note" id="n-aux">Toca para ingresar datos</div></div>
        <div class="crew-chev">‚ñº</div>
      </div>
      <div class="crew-bd">
        <div class="row2">
          <div class="field" id="f-an"><label>Nombre completo <span class="req">*</span></label><input type="text" id="aux_n" placeholder="Apellidos y nombres"><div class="ferr">Requerido</div></div>
          <div class="field" id="f-ac"><label>C√©dula <span class="req">*</span></label><input type="text" id="aux_c" placeholder="Sin puntos" inputmode="numeric"><div class="ferr">Requerido</div></div>
        </div>
        <div class="field">
          <label>Foto c√©dula <span class="req">*</span></label>
          <div class="photo-box" id="pb-aux"><input type="file" id="f-aux" accept="image/*" capture="environment" onchange="onPhoto(this,'aux')"><div class="ph-ico">üì∑</div><div class="ph-txt">Tomar o subir foto de c√©dula</div><div class="ph-hint">Frente de la c√©dula visible</div><div class="ph-st" id="ps-aux"></div></div>
          <div class="ferr" id="ef-aux">Se requiere foto de c√©dula</div>
        </div>
      </div>
    </div>

    <!-- DOBLADO -->
    <div class="dob-alert" id="dob-alert">
      <div style="font-weight:800;color:#EA580C;margin-bottom:5px;font-size:.84rem">‚ö†Ô∏è Personal con turno previo hoy</div>
      <div id="dob-detail" style="font-size:.76rem;color:#9A3412;line-height:1.7"></div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;font-size:.72rem;color:#9A3412;margin-top:8px">
        <input type="checkbox" id="dob-ok" style="width:15px;height:15px;accent-color:#F97316">
        Confirmo que est√° autorizado para doblar turno
      </label>
    </div>

    <div class="nav">
      <button class="btn-back" onclick="back(1)">‚Üê Volver</button>
      <button class="btn-next" onclick="next(3)">Siguiente ‚Äî Referente ‚Üí</button>
    </div>
  </div>
</div>

<!-- PASO 3: REFERENTE -->
<div class="card" id="s3">
  <div class="card-hd"><div class="card-num num-purple">03</div><div><div class="card-title">Profesional que Registra</div><div class="card-sub">Responsable de la veracidad</div></div></div>
  <div class="card-body">
    <div class="row2">
      <div class="field" id="f-rn">
        <label>Su nombre completo <span class="req">*</span></label>
        <input type="text" id="ref_n" placeholder="Apellidos y nombres">
        <div class="ferr">Ingrese su nombre</div>
      </div>
      <div class="field">
        <label>Su subred</label>
        <select id="ref_s"><option value="">Seleccionar‚Ä¶</option><option>Norte</option><option>Sur</option><option>Sur Occidente</option><option>Centro Oriente</option></select>
      </div>
    </div>
    <div class="field">
      <label>Observaciones <span style="color:var(--muted);font-weight:400">(opcional)</span></label>
      <textarea id="obs" placeholder="Novedad, cambio de personal, etc."></textarea>
    </div>
    <div class="nav">
      <button class="btn-back" onclick="back(2)">‚Üê Volver</button>
      <button class="btn-next" onclick="openConfirm()">Revisar y Confirmar ‚Üí</button>
    </div>
  </div>
</div>

</div><!-- /wrap -->

<!-- SUCCESS -->
<div class="success" id="success">
  <div class="s-circle">‚úì</div>
  <div class="s-title">¬°Turno Registrado!</div>
  <div class="s-sub">Los datos fueron enviados correctamente.</div>
  <div class="s-detail" id="s-detail"></div>
  <div class="s-sync" id="s-sync"></div>
  <button class="btn-new" onclick="resetAll()">+ Registrar otro turno</button>
</div>

<!-- MODAL CONFIRM -->
<div class="modal-bg" id="modal">
  <div class="modal-box">
    <div class="modal-title">üìã Confirmar Registro</div>
    <div class="modal-rows" id="modal-rows"></div>
    <div class="modal-warn">‚ö†Ô∏è <strong>Al confirmar</strong>, certifica que los datos son ver√≠dicos. Se registrar√° la hora exacta de env√≠o.</div>
    <button class="btn-confirm" id="btn-confirm" onclick="submitForm()">‚úì CONFIRMAR Y REGISTRAR</button>
    <button class="btn-modal-cancel" onclick="closeModal()">‚Üê Volver a editar</button>
  </div>
</div>

<div class="footer">Sistema SCAT ¬∑ Desarrollado por <strong>Ing. Edisson Mac√≠as</strong> ¬∑ Secretar√≠a de Salud Bogot√°</div>

<script>
const SHEET = 'https://script.google.com/macros/s/AKfycbwvimLL3DM70rOD1_WvFwgBLeWiPKqaftODpR3U9XAU2aeY45uALX8QOpuTuMkF8QaB/exec';
const LOCAL = 'scat_v3';

let step = 1;
let tipo = '';
let photos = { med:'', con:'', aux:'' }; // '' = no hay, 'ok' = tiene archivo
let photoFiles = { med:null, con:null, aux:null };

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.onload = () => {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('inicio').value = now.toISOString().slice(0,16);
};

// ‚îÄ‚îÄ TIPO DE M√ìVIL ‚îÄ‚îÄ
function onTipo() {
  tipo = document.querySelector('input[name="tipo"]:checked')?.value || '';
  const med = document.getElementById('cr-med');
  const aux = document.getElementById('cr-aux');
  const badge = document.getElementById('badge-med-con');
  const sub = document.getElementById('personal-sub');

  if (tipo === 'Medicalizada') {
    med.classList.remove('hide'); aux.classList.remove('hide');
    badge.style.display = 'none';
    sub.textContent = 'M√©dico + Conductor + Auxiliar';
  } else if (tipo === 'B√°sica') {
    med.classList.add('hide'); aux.classList.remove('hide');
    badge.style.display = 'none';
    sub.textContent = 'Conductor + Auxiliar';
    document.getElementById('med_n').value = '';
    document.getElementById('med_c').value = '';
    photos.med = ''; photoFiles.med = null;
  } else if (tipo === 'MED') {
    med.classList.remove('hide'); aux.classList.add('hide');
    badge.style.display = 'inline';
    sub.textContent = 'M√©dico + Auxiliar/Conductor';
    document.getElementById('aux_n').value = '';
    document.getElementById('aux_c').value = '';
    photos.aux = ''; photoFiles.aux = null;
  }
}

// ‚îÄ‚îÄ NAVEGACI√ìN ‚îÄ‚îÄ
function next(n) {
  if (!validate(step)) return;
  goTo(n);
}
function back(n) { goTo(n); }

function goTo(n) {
  document.getElementById('s' + step).classList.remove('show');
  document.getElementById('s' + n).classList.add('show');
  step = n;
  updateProgress();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateProgress() {
  for (let i = 1; i <= 3; i++) {
    const dot = document.getElementById('d' + i);
    const lbl = document.getElementById('l' + i);
    const line = document.getElementById('ln' + i);
    dot.className = 'prg-dot' + (i < step ? ' done' : i === step ? ' active' : '');
    dot.textContent = i < step ? '‚úì' : i;
    lbl.className = 'prg-lbl' + (i === step ? ' active' : '');
    if (line) line.className = 'prg-line' + (i < step ? ' done' : '');
  }
}

// ‚îÄ‚îÄ VALIDACI√ìN ‚îÄ‚îÄ
function validate(s) {
  let ok = true;
  const clr = id => document.getElementById(id)?.classList.remove('has-err');
  const err = id => { document.getElementById(id)?.classList.add('has-err'); ok = false; };

  if (s === 1) {
    clr('f-subred'); clr('f-placa'); clr('f-inicio');
    document.getElementById('err-tipo').style.display = 'none';
    document.getElementById('err-turno').style.display = 'none';
    if (!document.getElementById('subred').value) err('f-subred');
    if (!document.getElementById('placa').value.trim()) err('f-placa');
    if (!document.querySelector('input[name="tipo"]:checked')) { document.getElementById('err-tipo').style.display = 'block'; ok = false; }
    if (!document.querySelector('input[name="turno"]:checked')) { document.getElementById('err-turno').style.display = 'block'; ok = false; }
    if (!document.getElementById('inicio').value) err('f-inicio');
  }

  if (s === 2) {
    // Conductor siempre
    clr('f-cn'); clr('f-cc');
    if (!v('con_n')) { err('f-cn'); open('cr-con'); }
    if (!v('con_c')) { err('f-cc'); open('cr-con'); }
    if (!photos.con) { show('ef-con'); open('cr-con'); ok = false; }
    else hide('ef-con');

    // Auxiliar (no en MED)
    if (tipo !== 'MED') {
      clr('f-an'); clr('f-ac');
      if (!v('aux_n')) { err('f-an'); open('cr-aux'); }
      if (!v('aux_c')) { err('f-ac'); open('cr-aux'); }
      if (!photos.aux) { show('ef-aux'); open('cr-aux'); ok = false; }
      else hide('ef-aux');
    }

    // M√©dico (Medicalizada y MED)
    if (tipo === 'Medicalizada' || tipo === 'MED') {
      clr('f-mn'); clr('f-mc');
      if (!v('med_n')) { err('f-mn'); open('cr-med'); }
      if (!v('med_c')) { err('f-mc'); open('cr-med'); }
      if (!photos.med) { show('ef-med'); open('cr-med'); ok = false; }
      else hide('ef-med');
    }

    // Doblado
    if (ok) checkDoblado();
    const da = document.getElementById('dob-alert');
    if (da.style.display !== 'none' && !document.getElementById('dob-ok').checked) {
      da.style.borderColor = '#EF4444';
      da.scrollIntoView({ behavior: 'smooth', block: 'center' });
      ok = false;
    }
  }

  if (s === 3) {
    clr('f-rn');
    if (!v('ref_n')) err('f-rn');
  }

  if (!ok) {
    const fe = document.querySelector('.has-err');
    if (fe) fe.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  return ok;
}

const v = id => document.getElementById(id)?.value?.trim() || '';
const show = id => { const e = document.getElementById(id); if(e) e.style.display='block'; };
const hide = id => { const e = document.getElementById(id); if(e) e.style.display='none'; };
const open = id => document.getElementById(id)?.classList.add('open');

// ‚îÄ‚îÄ CREW ‚îÄ‚îÄ
function toggleCrew(id) { document.getElementById(id).classList.toggle('open'); }

// ‚îÄ‚îÄ FOTOS ‚îÄ‚îÄ
function onPhoto(input, role) {
  if (!input.files[0]) return;
  const file = input.files[0];
  photoFiles[role] = file;
  photos[role] = 'ok';
  const pb = document.getElementById('pb-' + role);
  const ps = document.getElementById('ps-' + role);
  pb.classList.add('ok');
  ps.className = 'ph-st ok';
  ps.textContent = '‚úì ' + file.name;
  hide('ef-' + role);
  // Update crew note
  const nameEl = document.getElementById('n-' + role);
  if (nameEl && nameEl.textContent === 'Toca para ingresar datos') return;
}

// ‚îÄ‚îÄ DOBLADO ‚Äî consulta directa a Google Sheets ‚îÄ‚îÄ
async function checkDoblado() {
  const personas = [
    { ced: v('con_c'), nombre: v('con_n'), rol: 'Conductor' },
    { ced: v('aux_c'), nombre: v('aux_n'), rol: 'Auxiliar' },
    { ced: v('med_c'), nombre: v('med_n'), rol: 'M√©dico' },
  ].filter(p => p.ced);

  if (!personas.length) return;

  const da = document.getElementById('dob-alert');
  const dd = document.getElementById('dob-detail');

  // Mostrar "consultando..."
  da.style.display = 'block';
  da.style.borderColor = '#94A3B8';
  dd.innerHTML = '<span style="color:#64748B;font-size:.75rem">‚è≥ Consultando historial en tiempo real...</span>';

  try {
    const cedulas = personas.map(p => p.ced).join(',');
    const data = await new Promise((resolve) => {
      const cb = '_chk_' + Date.now();
      const sc = document.createElement('script');
      window[cb] = d => { delete window[cb]; sc.remove(); resolve(d); };
      sc.onerror = () => { delete window[cb]; sc.remove(); resolve(null); };
      sc.src = SHEET + '?action=checkPersonal&cedulas=' + encodeURIComponent(cedulas) + '&callback=' + cb;
      setTimeout(() => resolve(null), 7000);
      document.head.appendChild(sc);
    });

    if (!data || data.status !== 'ok' || !data.resultados.length) {
      da.style.display = 'none';
      return;
    }

    // Construir alertas con info detallada
    let alertas = [];
    data.resultados.forEach(res => {
      const persona = personas.find(p => p.ced === res.cedula);
      res.encontrados.forEach(enc => {
        const hDesde = enc.hDesde != null ? enc.hDesde + 'h' : '';
        const hTrabajo = enc.horas != null ? enc.horas + 'h trabajadas' : '';
        if (enc.tipo === 'activo') {
          alertas.push(
            `üî¥ <strong>${enc.rol} ${enc.nombre || persona?.nombre}</strong> ‚Äî ` +
            `<strong>TURNO ACTIVO AHORA</strong> en m√≥vil <strong>${enc.placa}</strong> (${enc.subred} ¬∑ ${enc.turno})`
          );
        } else {
          alertas.push(
            `üü† <strong>${enc.rol} ${enc.nombre || persona?.nombre}</strong> ‚Äî ` +
            `Turno previo hace <strong>${hDesde}</strong> en m√≥vil <strong>${enc.placa}</strong> ` +
            `(${enc.subred} ¬∑ ${enc.turno}${hTrabajo ? ' ¬∑ ' + hTrabajo : ''})`
          );
        }
      });
    });

    if (alertas.length) {
      da.style.display = 'block';
      da.style.borderColor = '#F97316';
      document.getElementById('dob-ok').checked = false;
      dd.innerHTML = alertas.join('<br>');
    } else {
      da.style.display = 'none';
    }

  } catch(e) {
    // Si falla la consulta, ocultar alerta y continuar
    da.style.display = 'none';
  }
}

// ‚îÄ‚îÄ ABRIR MODAL CONFIRM ‚îÄ‚îÄ
function openConfirm() {
  if (!validate(3)) return;

  const tipo = document.querySelector('input[name="tipo"]:checked')?.value || '';
  const turno = document.querySelector('input[name="turno"]:checked')?.value || '';
  const inicio = v('inicio');
  const inicioFmt = inicio ? new Date(inicio).toLocaleString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}) : '';

  const row = (k, val) => val ? `<div class="mrow"><span class="mkey">${k}</span><span class="mval">${val}</span></div>` : '';

  let html = `
    <div class="mcard"><div class="mcard-title">üöë M√≥vil</div>${row('Subred', v('subred'))}${row('Placa', v('placa').toUpperCase())}${row('Tipo', tipo)}${row('Turno', turno)}${row('Inicio', inicioFmt)}</div>`;

  if (tipo === 'Medicalizada' || tipo === 'MED') {
    html += `<div class="mcard"><div class="mcard-title">üë®‚Äç‚öïÔ∏è M√©dico</div>${row('Nombre', v('med_n'))}${row('C√©dula', v('med_c'))}${row('Foto', photos.med ? '‚úÖ Lista' : '‚Äî')}</div>`;
  }

  html += `<div class="mcard"><div class="mcard-title">üöò Conductor${tipo==='MED'?' / Auxiliar':''}</div>${row('Nombre', v('con_n'))}${row('C√©dula', v('con_c'))}${row('Foto', photos.con ? '‚úÖ Lista' : '‚Äî')}</div>`;

  if (tipo !== 'MED') {
    html += `<div class="mcard"><div class="mcard-title">ü©∫ Auxiliar</div>${row('Nombre', v('aux_n'))}${row('C√©dula', v('aux_c'))}${row('Foto', photos.aux ? '‚úÖ Lista' : '‚Äî')}</div>`;
  }

  html += `<div class="mcard"><div class="mcard-title">üìã Referente</div>${row('Nombre', v('ref_n'))}${row('Subred', v('ref_s'))}${row('Observaciones', v('obs'))}</div>`;

  document.getElementById('modal-rows').innerHTML = html;
  document.getElementById('modal').classList.add('open');
}

function closeModal() { document.getElementById('modal').classList.remove('open'); }

// ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ
async function submitForm() {
  const btn = document.getElementById('btn-confirm');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Registrando...';

  const tipo = document.querySelector('input[name="tipo"]:checked')?.value || '';
  const obj = {
    id: Date.now(), ts: Date.now(),
    subred: v('subred'), placa: v('placa').toUpperCase(),
    tipo, turno: document.querySelector('input[name="turno"]:checked')?.value || '',
    inicio: v('inicio'),
    med_nombre: v('med_n'), med_cedula: v('med_c'), med_foto_url: '',
    con_nombre: v('con_n'), con_cedula: v('con_c'), con_foto_url: '',
    aux_nombre: tipo === 'MED' ? v('con_n') : v('aux_n'),
    aux_cedula: tipo === 'MED' ? v('con_c') : v('aux_c'),
    aux_foto_url: '',
    referente: v('ref_n'), ref_subred: v('ref_s'),
    observaciones: v('obs'), estado: 'activo',
    doblado: document.getElementById('dob-alert').style.display !== 'none' ? 'si' : 'no'
  };

  // Guardar local
  const db = JSON.parse(localStorage.getItem(LOCAL) || '[]');
  db.push(obj);
  localStorage.setItem(LOCAL, JSON.stringify(db));

  // Enviar a Sheets ‚Äî fire and forget, sin await
  const params = new URLSearchParams({ action: 'register', record: JSON.stringify(obj) });
  fetch(SHEET + '?' + params.toString(), { mode: 'no-cors' }).catch(() => {});

  // Subir fotos en segundo plano
  setTimeout(() => {
    if (photoFiles.med) uploadPhoto('med', obj.id);
    if (photoFiles.con) uploadPhoto('con', obj.id);
    if (tipo !== 'MED' && photoFiles.aux) uploadPhoto('aux', obj.id);
  }, 800);

  closeModal();

  // Mostrar √©xito
  document.getElementById('s' + step).classList.remove('show');
  document.getElementById('success').classList.add('show');

  document.getElementById('s-detail').innerHTML =
    `<strong>${obj.placa} ¬∑ Subred ${obj.subred} ¬∑ ${tipo}</strong><br>
    ${obj.med_nombre ? 'M√©dico: ' + obj.med_nombre + '<br>' : ''}
    Conductor: ${obj.con_nombre}<br>
    ${tipo !== 'MED' ? 'Auxiliar: ' + obj.aux_nombre + '<br>' : ''}
    Referente: ${obj.referente}<br>
    Hora: ${new Date().toLocaleTimeString('es-CO', { hour12: false })}`;

  document.getElementById('s-sync').textContent = '‚úì Turno guardado ‚Äî datos enviados a Google Sheets';
  document.getElementById('s-sync').className = 's-sync ok';

  btn.disabled = false;
  btn.innerHTML = '‚úì CONFIRMAR Y REGISTRAR';
}

// ‚îÄ‚îÄ FOTO UPLOAD BACKGROUND ‚îÄ‚îÄ
async function uploadPhoto(role, recordId) {
  const file = photoFiles[role];
  if (!file) return;
  try {
    const b64 = await toBase64(file);
    await fetch(SHEET, {
      method: 'POST',
      body: JSON.stringify({ action: 'uploadPhoto', base64: b64.split(',')[1], mimeType: file.type, filename: `SCAT_${role}_${recordId}.jpg`, recordId: String(recordId), role }),
      headers: { 'Content-Type': 'text/plain' }
    });
  } catch (e) { console.warn('Photo upload failed:', e); }
}

function toBase64(file) {
  return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });
}

// ‚îÄ‚îÄ RESET ‚îÄ‚îÄ
function resetAll() {
  document.querySelectorAll('input[type=text], select, textarea').forEach(el => el.value = '');
  document.querySelectorAll('input[type=radio]').forEach(el => el.checked = false);
  document.querySelectorAll('input[type=checkbox]').forEach(el => el.checked = false);
  document.querySelectorAll('.photo-box').forEach(el => el.classList.remove('ok'));
  document.querySelectorAll('.ph-st').forEach(el => { el.textContent = ''; el.className = 'ph-st'; });
  document.querySelectorAll('.has-err').forEach(el => el.classList.remove('has-err'));
  document.querySelectorAll('.err-msg').forEach(el => el.style.display = 'none');
  document.getElementById('cr-med').classList.add('hide');
  document.getElementById('cr-aux').classList.add('hide');
  document.getElementById('dob-alert').style.display = 'none';
  document.getElementById('success').classList.remove('show');
  photos = { med: '', con: '', aux: '' };
  photoFiles = { med: null, con: null, aux: null };
  tipo = '';
  step = 1;
  updateProgress();
  document.getElementById('s1').classList.add('show');
  const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('inicio').value = now.toISOString().slice(0, 16);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Live crew notes
document.addEventListener('input', () => {
  [['med_n','n-med'],['con_n','n-con'],['aux_n','n-aux']].forEach(([src, tgt]) => {
    const val = document.getElementById(src)?.value.trim();
    const el = document.getElementById(tgt);
    if (el && val) el.textContent = val;
  });
});
</script>
</body>
</html>
